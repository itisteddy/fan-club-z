{"version":3,"file":"AuthCallback-6d420bf9.js","sources":["../../src/pages/auth/AuthCallback.tsx"],"sourcesContent":["import React, { useEffect, useState } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport { useSupabase } from '../../providers/SupabaseProvider';\nimport { consumeReturnTo, sanitizeInternalPath } from '../../lib/returnTo';\n\nfunction Spinner() {\n  return (\n    <div className=\"flex h-screen items-center justify-center bg-gray-50\">\n      <div className=\"text-center\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-500 mx-auto mb-4\"></div>\n        <h2 className=\"text-xl font-semibold text-gray-900 mb-2\">Completing Sign In...</h2>\n        <p className=\"text-gray-600\">Please wait while we finish setting up your account.</p>\n      </div>\n    </div>\n  );\n}\n\nconst AuthCallback: React.FC = () => {\n  const { supabase } = useSupabase();\n  const navigate = useNavigate();\n  const [error, setError] = useState<string | null>(null);\n\n  // Helper: small delay\n  const sleep = (ms: number) => new Promise((resolve) => setTimeout(resolve, ms));\n\n  // Helper: wait briefly for Supabase to materialize a session from the URL\n  const waitForSession = async (maxWaitMs: number = 2000): Promise<ReturnType<typeof supabase.auth.getSession>> => {\n    const started = Date.now();\n    let lastResult = await supabase.auth.getSession();\n\n    while (!lastResult.data.session && Date.now() - started < maxWaitMs) {\n      await sleep(250);\n      lastResult = await supabase.auth.getSession();\n    }\n\n    return lastResult;\n  };\n\n  useEffect(() => {\n    const handleCallback = async () => {\n      try {\n        console.log('================================================================================');\n        console.log('AUTH CALLBACK STARTED');\n        console.log('================================================================================');\n        console.log('Current URL:', window.location.href);\n        \n        // First, check if we already have a valid session\n        const { data: { session: existingSession }, error: sessionCheckError } = await supabase.auth.getSession();\n        if (existingSession && !sessionCheckError) {\n          console.log('âœ… Already have a valid session, skipping PKCE flow');\n          console.log('User:', existingSession.user.email);\n          \n          // Get the next parameter and redirect\n          const searchParams = new URLSearchParams(window.location.search);\n          const nextFromUrl = searchParams.get('next');\n          const nextFromStorage = consumeReturnTo();\n          const target = sanitizeInternalPath(nextFromUrl ?? nextFromStorage ?? '/');\n          \n          console.log('Redirecting to:', target);\n          await new Promise(resolve => setTimeout(resolve, 500));\n          navigate(target, { replace: true });\n          return;\n        }\n        \n        // Get the next parameter from URL\n        const searchParams = new URLSearchParams(window.location.search);\n        let nextFromUrl = searchParams.get('next');\n        \n        // Decode and sanitize the next parameter\n        if (nextFromUrl) {\n          try {\n            nextFromUrl = decodeURIComponent(nextFromUrl);\n            // If it's a full production URL, strip it to just the path\n            if (nextFromUrl.includes('app.fanclubz.app') && !import.meta.env.PROD) {\n              console.warn('âš ï¸ Blocked production URL in next parameter, using path only');\n              const url = new URL(nextFromUrl);\n              nextFromUrl = url.pathname + url.search + url.hash;\n            }\n          } catch (e) {\n            console.warn('Failed to decode next parameter:', e);\n            nextFromUrl = null;\n          }\n        }\n        \n        console.log('Next from URL:', nextFromUrl);\n        console.log('Decoded next:', nextFromUrl);\n        \n        // Get from sessionStorage as fallback\n        const nextFromStorage = consumeReturnTo();\n        console.log('Next from storage:', nextFromStorage);\n        \n        // Sanitize storage value too\n        let sanitizedStorage = nextFromStorage;\n        if (sanitizedStorage && sanitizedStorage.includes('app.fanclubz.app') && !import.meta.env.PROD) {\n          console.warn('âš ï¸ Blocked production URL in returnTo storage, using path only');\n          try {\n            const url = new URL(sanitizedStorage);\n            sanitizedStorage = url.pathname + url.search + url.hash;\n          } catch {\n            sanitizedStorage = null;\n          }\n        }\n        \n        // Detect what type of auth flow we're handling\n        const hash = window.location.hash || '';\n        const hasHashAccessToken = hash.includes('access_token=');\n        const hasQueryAccessToken = Boolean(searchParams.get('access_token'));\n        const code = searchParams.get('code');\n        const isOAuthFlow = Boolean(code); // OAuth (Google, etc.) uses code parameter\n        const isMagicLinkFlow = hasHashAccessToken || hasQueryAccessToken; // Magic link uses access_token\n        \n        console.log('Auth flow detection:', {\n          isOAuthFlow,\n          isMagicLinkFlow,\n          hasCode: Boolean(code),\n          hasAccessToken: hasHashAccessToken || hasQueryAccessToken\n        });\n        \n        // For magic-link flows: explicitly parse URL tokens\n        if (isMagicLinkFlow && !isOAuthFlow) {\n          console.log('Detected magic-link parameters in URL, calling getSessionFromUrl...');\n          try {\n            const { data: urlData, error: urlError } = await (supabase.auth as any).getSessionFromUrl({\n              storeSession: true,\n            });\n            if (urlError) {\n              console.warn('getSessionFromUrl reported error:', urlError.message || urlError);\n            } else {\n              console.log('getSessionFromUrl session result:', !!urlData?.session);\n            }\n          } catch (urlException: any) {\n            console.warn('getSessionFromUrl threw exception:', urlException?.message || urlException);\n          }\n        }\n        \n        // For OAuth flows (Google, etc.): Supabase handles code exchange automatically\n        // via detectSessionInUrl, but we give it a moment to process\n        if (isOAuthFlow) {\n          console.log('Detected OAuth flow (code parameter present)');\n          console.log('Supabase should automatically handle PKCE code exchange...');\n          // Give Supabase time to process the OAuth callback\n          await sleep(500);\n        }\n\n        // ðŸ” Final session check (handles both PKCE and magic-link flows)\n        // Give Supabase a short window to hydrate the session from the URL\n        const { data: { session: finalSession }, error: finalSessionError } = await waitForSession(2500);\n        if (finalSessionError) {\n          console.error('Final session check error:', finalSessionError);\n          throw finalSessionError;\n        }\n\n        if (!finalSession) {\n          // Determine which error message to show based on flow type\n          if (isOAuthFlow) {\n            throw new Error('Google sign-in failed. Please try signing in again. If the problem persists, try clearing your browser cookies and cache.');\n          } else if (isMagicLinkFlow) {\n            throw new Error('This sign-in link is invalid or has already been used. Please request a new email link to sign in.');\n          } else {\n            throw new Error('Authentication failed. Please try signing in again.');\n          }\n        }\n\n        console.log('Using authenticated session for redirect:', finalSession.user.email);\n\n        // Determine where to redirect\n        const target = sanitizeInternalPath(nextFromUrl ?? sanitizedStorage ?? '/');\n        console.log('Final redirect target:', target);\n        console.log('Current origin:', window.location.origin);\n        console.log('Environment PROD:', import.meta.env.PROD);\n        console.log('================================================================================');\n        \n        // Small delay to ensure session is fully established\n        await new Promise(resolve => setTimeout(resolve, 500));\n        \n        // Navigate to target using react-router-dom\n        console.log('Navigating to:', target);\n        navigate(target, { replace: true });\n      } catch (err: any) {\n        console.error('Auth callback error:', err);\n        console.error('Error details:', {\n          message: err.message,\n          code: err.code,\n          status: err.status,\n          name: err.name\n        });\n        setError(err.message || 'Authentication failed');\n      }\n    };\n\n    handleCallback();\n  }, [supabase, navigate]);\n\n  if (error) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-gray-50\">\n        <div className=\"text-center max-w-md mx-auto p-6\">\n          <div className=\"bg-red-50 rounded-lg p-4 mb-4\">\n            <div className=\"flex items-center justify-center w-12 h-12 mx-auto mb-4 bg-red-100 rounded-full\">\n              <svg className=\"w-6 h-6 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z\" />\n              </svg>\n            </div>\n            <h2 className=\"text-lg font-semibold text-red-800 mb-2\">Authentication Error</h2>\n            <p className=\"text-red-600 text-sm mb-4\">{error}</p>\n          </div>\n          <button\n            onClick={() => navigate('/', { replace: true })}\n            className=\"bg-emerald-500 text-white px-6 py-2 rounded-lg hover:bg-emerald-600 transition-colors\"\n          >\n            Return to Home\n          </button>\n        </div>\n      </div>\n    );\n  }\n\n  return <Spinner />;\n};\n\nexport default AuthCallback;\n"],"names":["Spinner","jsxs","jsx","AuthCallback","supabase","useSupabase","navigate","useNavigate","error","setError","useState","sleep","ms","resolve","waitForSession","maxWaitMs","started","lastResult","useEffect","existingSession","sessionCheckError","nextFromUrl","nextFromStorage","consumeReturnTo","target","sanitizeInternalPath","searchParams","sanitizedStorage","hasHashAccessToken","hasQueryAccessToken","isOAuthFlow","isMagicLinkFlow","urlData","urlError","finalSession","finalSessionError","err"],"mappings":"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"}