import{f as h,w as _,x as $,y as A,G as S,H as k,I as f,a as E}from"./index-9e31fc92.js";import{c as T}from"./utils-ac284782.js";/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const U=h("Heart",[["path",{d:"M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z",key:"c3ymky"}]]);/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const B=h("MessageCircle",[["path",{d:"M7.9 20A9 9 0 1 0 4 16.1L2 22Z",key:"vv11sd"}]]);/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const j=h("Send",[["path",{d:"m22 2-7 20-4-9-9-4Z",key:"1q3vgg"}],["path",{d:"M22 2 11 13",key:"nzbqef"}]]),g=A,C=S;let D=null;if(!g.includes("demo"))try{D=_(g,C)}catch{console.warn("Supabase not configured, using demo mode")}const x=$(),M="v2",d=`${x}/api/${M}`,P=()=>localStorage.getItem("token"),y={get:async(e,o)=>{const t=P();try{const a=await fetch(`${d}${e}`,{method:"GET",headers:{"Content-Type":"application/json",...t&&{Authorization:`Bearer ${t}`},...o?.headers},...o});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);return a.json()}catch(a){throw console.warn(`API call failed: ${e}`,a),a}},post:async(e,o,t)=>{const a=P();try{const r=await fetch(`${d}${e}`,{method:"POST",headers:{"Content-Type":"application/json",...a&&{Authorization:`Bearer ${a}`},...t?.headers},body:o?JSON.stringify(o):void 0,...t});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);return r.json()}catch(r){throw console.warn(`API call failed: ${e}`,r),r}},put:async(e,o,t)=>{const a=P();try{const r=await fetch(`${d}${e}`,{method:"PUT",headers:{"Content-Type":"application/json",...a&&{Authorization:`Bearer ${a}`},...t?.headers},body:o?JSON.stringify(o):void 0,...t});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);return r.json()}catch(r){throw console.warn(`API call failed: ${e}`,r),r}},delete:async(e,o)=>{const t=P();try{const a=await fetch(`${d}${e}`,{method:"DELETE",headers:{"Content-Type":"application/json",...t&&{Authorization:`Bearer ${t}`},...o?.headers},...o});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);return a.json()}catch(a){throw console.warn(`API call failed: ${e}`,a),a}}},m=e=>({id:e.id,predictionId:e.prediction_id,user:{id:e.user?.id||e.user_id,username:e.user?.username||"Anonymous",full_name:e.user?.full_name,avatarUrl:e.user?.avatar_url,avatar_url:e.user?.avatar_url,is_verified:e.user?.is_verified||!1},text:e.content||e.text||"",content:e.content,createdAt:e.created_at||e.createdAt||new Date().toISOString(),created_at:e.created_at,updatedAt:e.updated_at||e.updatedAt||new Date().toISOString(),updated_at:e.updated_at,edited:e.is_edited||e.edited||!1,is_edited:e.is_edited,isDeleted:e.is_deleted||!1,likeCount:e.likes_count||e.likeCount||0,likes_count:e.likes_count,likedByMe:e.is_liked||e.likedByMe||!1,is_liked:e.is_liked});function w(e){return!e||e.name==="TypeError"||e.message?.includes("Failed to fetch")?"network_error":e.status>=500?"server_error":e.status>=400&&e.status<500?"client_error":e.name==="SyntaxError"||e.message?.includes("JSON")?"parse_error":"network_error"}const z=T()(k((e,o)=>({byPrediction:{},getComments:t=>o().byPrediction[t]?.items||[],getCommentCount:t=>o().byPrediction[t]?.items?.length||0,getStatus:t=>o().byPrediction[t]?.status||"idle",getDraft:t=>o().byPrediction[t]?.draft||"",isPosting:t=>o().byPrediction[t]?.posting||!1,hasMore:t=>o().byPrediction[t]?.nextCursor!==null,fetchComments:async t=>{if(!(!t?.trim()||o().byPrediction[t]?.status==="loading")){e(r=>({byPrediction:{...r.byPrediction,[t]:{...r.byPrediction[t],status:"loading"}}}));try{let r;try{r=await y.get(`/social/predictions/${t}/comments?page=1&limit=20`)}catch(c){f("Social endpoint failed, trying comments endpoint:",c),r=await y.get(`/comments/predictions/${t}/comments?page=1&limit=20`)}let n=[],s=null;r.data&&Array.isArray(r.data)?(n=r.data.map(m),s=r.pagination?.hasNext?"next":null):r.comments&&Array.isArray(r.comments)?(n=r.comments.map(m),s=r.hasMore?"next":null):Array.isArray(r)&&(n=r.map(m)),f(`Fetched ${n.length} comments for ${t}`),e(c=>({byPrediction:{...c.byPrediction,[t]:{...c.byPrediction[t],items:n,nextCursor:s,status:"loaded"}}}))}catch(r){if(r.status===404){e(s=>({byPrediction:{...s.byPrediction,[t]:{...s.byPrediction[t],items:[],nextCursor:null,status:"loaded"}}}));return}const n=w(r);e(s=>({byPrediction:{...s.byPrediction,[t]:{...s.byPrediction[t],items:s.byPrediction[t]?.items||[],status:n}}}))}}},loadMore:async t=>{if(!t?.trim())return;const a=o().byPrediction[t];if(!(!a?.nextCursor||a?.status==="paginating")){e(r=>({byPrediction:{...r.byPrediction,[t]:{...r.byPrediction[t],status:"paginating"}}}));try{const r=Math.ceil((a.items?.length||0)/20)+1;let n;try{n=await y.get(`/social/predictions/${t}/comments?page=${r}&limit=20`)}catch{n=await y.get(`/comments/predictions/${t}/comments?page=${r}&limit=20`)}let s=[],c=null;n.data&&Array.isArray(n.data)?(s=n.data.map(m),c=n.pagination?.hasNext?"next":null):n.comments&&Array.isArray(n.comments)&&(s=n.comments.map(m),c=n.hasMore?"next":null),f(`Loaded ${s.length} more comments for ${t}`),e(i=>({byPrediction:{...i.byPrediction,[t]:{...i.byPrediction[t],items:[...i.byPrediction[t]?.items||[],...s],nextCursor:c,status:"loaded"}}}))}catch(r){const n=w(r);e(s=>({byPrediction:{...s.byPrediction,[t]:{...s.byPrediction[t],status:n}}}))}}},addComment:async(t,a)=>{if(!t?.trim()||!a?.trim())throw new Error("Invalid input");const r=a.trim();if(r.length>280)throw new Error("Comment too long");e(i=>({byPrediction:{...i.byPrediction,[t]:{...i.byPrediction[t],posting:!0}}}));const{user:n}=E.getState(),s=`temp_${Date.now()}`,c={id:s,predictionId:t,user:{id:n?.id||"demo-user",username:n?.username||"You",full_name:n?.full_name,avatarUrl:n?.avatar_url,is_verified:n?.is_verified||!1},text:r,content:r,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),edited:!1,isDeleted:!1,likeCount:0,likedByMe:!1};e(i=>{const l=i.byPrediction[t]?.items||[];return{byPrediction:{...i.byPrediction,[t]:{...i.byPrediction[t],items:[c,...l]}}}});try{let i;try{i=await y.post(`/social/predictions/${t}/comments`,{content:r,userId:n?.id||"demo-user",user:n})}catch(u){f("Social endpoint failed, trying comments endpoint:",u),i=await y.post(`/comments/predictions/${t}/comments`,{content:r,user:n})}let l;i.data||i.success&&i.data?l=m(i.data):l=m(i),f(`Comment added successfully for ${t}`),e(u=>({byPrediction:{...u.byPrediction,[t]:{...u.byPrediction[t],items:u.byPrediction[t]?.items.map(b=>b.id===s?l:b)||[l],posting:!1,draft:""}}}));try{sessionStorage.removeItem(`fcz_comment_draft_${t}`)}catch{}}catch(i){throw e(l=>({byPrediction:{...l.byPrediction,[t]:{...l.byPrediction[t],items:l.byPrediction[t]?.items.filter(u=>u.id!==s)||[],posting:!1}}})),i}},editComment:async(t,a,r)=>{if(!t?.trim()||!a?.trim()||!r?.trim())throw new Error("Invalid input");const n=r.trim();if(n.length>280)throw new Error("Comment too long");const s=o().byPrediction[t]?.items.find(c=>c.id===a);if(!s)throw new Error("Comment not found");e(c=>({byPrediction:{...c.byPrediction,[t]:{...c.byPrediction[t],items:c.byPrediction[t]?.items.map(i=>i.id===a?{...i,text:n,edited:!0,updatedAt:new Date().toISOString()}:i)||[]}}}));try{let c;try{c=await y.put(`/social/comments/${a}`,{content:n})}catch{c=await y.put(`/comments/${a}`,{content:n})}let i;c.data?i=m(c.data):i=m(c),e(l=>({byPrediction:{...l.byPrediction,[t]:{...l.byPrediction[t],items:l.byPrediction[t]?.items.map(u=>u.id===a?i:u)||[]}}}))}catch(c){throw e(i=>({byPrediction:{...i.byPrediction,[t]:{...i.byPrediction[t],items:i.byPrediction[t]?.items.map(l=>l.id===a?s:l)||[]}}})),c}},deleteComment:async(t,a)=>{if(!t?.trim()||!a?.trim())throw new Error("Invalid input");const r=o().byPrediction[t]?.items||[];if(!r.find(s=>s.id===a))throw new Error("Comment not found");e(s=>({byPrediction:{...s.byPrediction,[t]:{...s.byPrediction[t],items:s.byPrediction[t]?.items.filter(c=>c.id!==a)||[]}}}));try{try{await y.delete(`/social/comments/${a}`)}catch{await y.delete(`/comments/${a}`)}f(`Comment ${a} deleted successfully`)}catch(s){throw e(c=>({byPrediction:{...c.byPrediction,[t]:{...c.byPrediction[t],items:r}}})),s}},setDraft:(t,a)=>{e(r=>({byPrediction:{...r.byPrediction,[t]:{...r.byPrediction[t],draft:a}}}));try{a.trim()?sessionStorage.setItem(`fcz_comment_draft_${t}`,a):sessionStorage.removeItem(`fcz_comment_draft_${t}`)}catch{}},clearDraft:t=>{e(a=>({byPrediction:{...a.byPrediction,[t]:{...a.byPrediction[t],draft:""}}}));try{sessionStorage.removeItem(`fcz_comment_draft_${t}`)}catch{}},setHighlighted:(t,a)=>{e(r=>({byPrediction:{...r.byPrediction,[t]:{...r.byPrediction[t],highlightedId:a}}})),a&&setTimeout(()=>{e(r=>({byPrediction:{...r.byPrediction,[t]:{...r.byPrediction[t],highlightedId:void 0}}}))},1500)}}),{name:"fcz-unified-comments",partialize:e=>({})})),L=e=>{const o=z();return{comments:o.getComments(e),commentCount:o.getCommentCount(e),status:o.getStatus(e),draft:o.getDraft(e),isPosting:o.isPosting(e),hasMore:o.hasMore(e),fetchComments:()=>o.fetchComments(e),loadMore:()=>o.loadMore(e),addComment:t=>o.addComment(e,t),editComment:(t,a)=>o.editComment(e,t,a),deleteComment:t=>o.deleteComment(e,t),setDraft:t=>o.setDraft(e,t),clearDraft:()=>o.clearDraft(e),setHighlighted:t=>o.setHighlighted(e,t)}};export{U as H,B as M,j as S,z as a,L as u};
