import{u as pe,b as be}from"./utils-617af415.js";import{a4 as se,Q as xe,l as ae,A as ge,c as ye,z as c,f as ve,p as I,a as Ne,al as ke,m as L,aq as je,ar as Ce,q as ee,r as _e,s as te,t as Se}from"./index-78beacc5.js";import{j as t}from"./ui-c369d1f3.js";import{r as i}from"./vendor-c36eaa8e.js";import{u as Ee}from"./useWalletConnectSession-1627a74c.js";import{j as g,m as Ie,r as We,t as Ae,v as Te,g as Re,y as qe,w as Me}from"./wagmi-c444efa6.js";import{c as Be}from"./utils-ae6b997d.js";/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ue=se("AlertOctagon",[["polygon",{points:"7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2",key:"h1p8hx"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=se("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);function Oe(e){const r=De(e.kind)?e.kind:Pe(e.type,e.channel,e.direction);return{id:e.id,kind:r,amountUSD:Math.abs(Number(e.amount||e.amountUSD||0)),txHash:e.txHash||e.meta?.txHash||e.external_ref?.split(":")[0],createdAt:e.createdAt||e.created_at||e.timestamp,meta:{predictionId:e.prediction_id||e.meta?.prediction_id,predictionTitle:e.meta?.prediction_title||e.description,optionId:e.meta?.option_id,optionLabel:e.meta?.option_label,entryId:e.entry_id,lockId:e.meta?.lock_id,userId:e.user_id,provider:e.provider,channel:e.channel,description:e.description,...e.meta}}}function De(e){return typeof e=="string"&&["deposit","withdraw","lock","release","entry","claim","payout","unlock","bet_refund","creator_fee","platform_fee","settlement","win","loss","bet_placed"].includes(e)}function Pe(e,r,u){return e==="win"||r==="payout"?"win":e==="loss"||r==="settlement_loss"?"loss":e==="credit"&&r==="escrow_deposit"||e==="credit"&&r==="crypto"||e==="deposit"||r==="blockchain_deposit"?"deposit":e==="debit"&&(r==="escrow_withdrawal"||r==="escrow_withdraw")||e==="debit"&&r==="crypto"||e==="withdraw"||r==="blockchain_withdraw"?"withdraw":e==="unlock"||r==="escrow_unlock"?"unlock":e==="bet_lock"||r==="escrow_consumed"||r==="blockchain_bet_lock"||r==="escrow_locked"?"lock":e==="bet_release"||r==="escrow_release"||r==="escrow_released"||r==="blockchain_bet_release"?"release":e==="bet_entry"||r==="prediction_entry"?"entry":e==="bet_refund"?"bet_refund":e==="settlement"||r==="blockchain_settlement"?"settlement":e==="creator_fee"||r==="creator_fee"||r==="blockchain_fee"?"creator_fee":e==="platform_fee"||r==="platform_fee"?"platform_fee":e==="claim"||r==="settlement_claim"||r==="blockchain_claim"?"claim":e==="payout"||r==="settlement_payout"?"payout":u==="credit"?"deposit":u==="debit"?"withdraw":"entry"}function $e(e,r,u=12e3){const l=new AbortController,w=setTimeout(()=>l.abort(),u);return fetch(e,{...r||{},signal:l.signal}).finally(()=>clearTimeout(w))}function nt(e,r=20){return pe({queryKey:xe.walletActivity(e??"anon",r),enabled:!!e,queryFn:async()=>{if(!e)throw new Error("userId is required");const l=new URLSearchParams({userId:e,limit:String(r)}),w=ae();let n;try{n=await $e(`${w}/api/wallet/activity?${l.toString()}`,{headers:{Accept:"application/json"}})}catch(m){throw m?.name==="AbortError"?new Error("Wallet activity request timed out. Please try again."):m}if(!n.ok){const m=await n.json().catch(()=>({message:n.statusText}));throw new Error(m.message||"Failed to load transactions")}return{items:((await n.json()).items||[]).map(m=>{try{return Oe(m)}catch{return null}}).filter(m=>m!==null)}},refetchInterval:6e4,staleTime:45e3,gcTime:12e4,retry:2,refetchOnWindowFocus:!1,refetchOnMount:!1})}function He(e){const{isConnected:r,address:u,chainId:l,sessionHealthy:w=!0,expectedChainId:n=g.id,status:p,isTransitioning:W=!1}=e;return p==="reconnecting"||p==="connecting"||W?{code:"reconnecting",message:null,requiresAction:!1,expectedChainId:n}:!r||!u?{code:"disconnected",message:"Connect your wallet to continue.",requiresAction:!0,expectedChainId:n}:l!==n?{code:"wrong_network",message:"Switch your wallet to Base Sepolia.",requiresAction:!0,expectedChainId:n}:w?{code:"ready",message:null,requiresAction:!1,expectedChainId:n}:{code:"session_unhealthy",message:"Wallet session expired. Please reconnect your wallet.",requiresAction:!0,expectedChainId:n}}const Ke={warning:{bg:"bg-amber-25 dark:bg-amber-950/40",border:"border border-amber-100 dark:border-amber-900/60",text:"text-amber-900 dark:text-amber-100",icon:ge},error:{bg:"bg-rose-25 dark:bg-rose-950/40",border:"border border-rose-100 dark:border-rose-900/60",text:"text-rose-900 dark:text-rose-100",icon:Ue},info:{bg:"bg-blue-25 dark:bg-blue-950/40",border:"border border-blue-100 dark:border-blue-900/60",text:"text-blue-900 dark:text-blue-100",icon:Fe}};function Le({tone:e="warning",title:r,message:u,actions:l,className:w}){const n=Ke[e],p=n.icon;return t.jsx("div",{className:Be("rounded-xl px-3 py-3 text-sm shadow-sm",n.bg,n.border,n.text,w),children:t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"rounded-lg bg-white/60 p-1.5 text-xs text-current shadow-sm",children:t.jsx(p,{className:"h-4 w-4"})}),t.jsxs("div",{className:"flex-1 space-y-1",children:[r&&t.jsx("p",{className:"text-sm font-semibold leading-tight",children:r}),t.jsx("div",{className:"text-sm leading-relaxed text-current/90",children:u}),l&&t.jsx("div",{className:"pt-2",children:l})]})]})})}const ze=Re("0x30c60f688A0082D1b761610ec3c70f6dC1374E95"),Ve=[{type:"function",name:"withdraw",stateMutability:"nonpayable",inputs:[{name:"amount",type:"uint256"}],outputs:[]}];function Qe(e){return BigInt(Math.round(e*1e6))}function z(e){return Math.max(0,Math.floor(e*100)/100)}function re(e){return`$${e.toLocaleString(void 0,{maximumFractionDigits:2})}`}function it({open:e,isOpen:r,onClose:u,availableUSDC:l=0,userId:w="",escrowAddress:n=ze,escrowAbi:p=Ve,title:W="Withdraw from Base",onSuccess:m}){const B=be(),{address:d,chainId:k,isConnected:_,connector:Ge}=Ie(),A=We(),{switchChainAsync:U}=Ae(),{writeContractAsync:ne,reset:F}=Te(),{sessionHealthy:O}=ye(),{recoverFromError:ie,withSessionRecovery:oe,cleanupWalletConnectSessions:ce,disconnectWithCleanup:V}=Ee(),[D,P]=i.useState(0),[f,Q]=i.useState(!1),[y,S]=i.useState("input"),[G,j]=i.useState(null),[$,C]=i.useState(""),H=i.useRef(!1),T=i.useRef(!0);i.useEffect(()=>(T.current=!0,()=>{T.current=!1}),[]);const E=e??r??!1;i.useEffect(()=>{E||(P(0),S("input"),j(null),C(""),H.current=!1,F())},[E,F]),i.useEffect(()=>{if(!E)return;const s=a=>a.key==="Escape"&&!f&&v();return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[E,f]);const v=i.useCallback(()=>{f&&(H.current=!0),u()},[f,u]);if(!E)return null;const b=He({isConnected:_,address:d,chainId:k,expectedChainId:g.id,sessionHealthy:O}),le=b.code==="ready",R=i.useCallback(()=>{window.dispatchEvent(new CustomEvent("fcz:wallet:connect"))},[]),J=i.useCallback(()=>{U({chainId:g.id}).catch(()=>{c.error("Approve the network switch request in your wallet.")})},[U]),X=i.useCallback(async()=>{try{await V()}catch{}finally{R()}},[V,R]),de=i.useMemo(()=>{const s=[],a="inline-flex items-center rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 hover:bg-slate-50 transition-colors";return b.code==="disconnected"&&s.push(t.jsx("button",{type:"button",className:"inline-flex items-center rounded-lg bg-emerald-600 px-3 py-1.5 text-xs font-semibold text-white hover:bg-emerald-700 transition-colors",onClick:R,children:"Connect wallet"},"connect")),b.code==="wrong_network"&&s.push(t.jsx("button",{type:"button",className:a,onClick:J,children:"Switch network"},"switch")),b.code==="session_unhealthy"&&s.push(t.jsx("button",{type:"button",className:"inline-flex items-center rounded-lg bg-amber-500 px-3 py-1.5 text-xs font-semibold text-white hover:bg-amber-600 transition-colors",onClick:X,children:"Reconnect wallet"},"reconnect")),s.length?t.jsx("div",{className:"flex flex-wrap gap-2",children:s}):null},[X,J,R,b.code]);if(!n)return t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",onClick:v,children:t.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4",onClick:s=>s.stopPropagation(),children:[t.jsx("h2",{className:"text-lg font-semibold mb-2 text-red-600",children:"Configuration Error"}),t.jsx("p",{className:"text-gray-600 mb-4",children:"Escrow contract address is not configured. Please contact support."}),t.jsx("button",{onClick:v,className:"w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300",children:"Close"})]})});const x=z(D||0),Y=x>z(l),Z=k===g.id,ue=!le||!_||!Z||f||x<=0||Y;async function me(){if(k!==g.id)try{await U({chainId:g.id})}catch(s){if(!await K(s)){const h=I(s);c.error(h.message),j(h.message)}throw s}}async function K(s){if(!_e(s))return!1;try{return te(),await ie({attemptReconnect:!0}),c.error("Wallet session expired. Please reconnect and try again.",{id:"session-error"}),Se("Wallet session expired"),!0}catch{return te(),await ce(),c.error("Wallet connection lost. Please reconnect.",{id:"session-error"}),!0}}const fe=i.useCallback(()=>{try{return ve({address:d,chainId:k,expectedChainId:g.id,isConnected:_,sessionHealthy:O}),!0}catch(s){const a=I(s);return j(a.message),c.error(a.message),!1}},[d,k,_,O]);async function we(){if(!d||!n){c.error("Wallet not connected");return}if(!fe())return;const s=Ne.getState().user?.id||w;let a=null;try{Q(!0),j(null),C(""),F(),await me();const h=Qe(x);if(S("simulating"),C("Validating withdrawal..."),A)try{await qe(A,{address:n,abi:p,functionName:"withdraw",args:[h],account:d})}catch(o){const N=I(o);throw N.code==="INSUFFICIENT_GAS"?c.error("Not enough ETH on Base Sepolia to pay gas. Add ETH and try again.",{id:"withdraw"}):N.code==="INSUFFICIENT_BALANCE"||N.code==="INSUFFICIENT_ESCROW"?c.error("Insufficient escrow balance to withdraw.",{id:"withdraw"}):c.error(N.message,{id:"withdraw"}),o}S("withdrawing"),C("Confirm withdrawal in your wallet..."),c.loading("Confirm withdrawal in your wallet...",{id:"withdraw"});try{a=await oe(async()=>await ne({address:n,abi:p,functionName:"withdraw",args:[h]}),{maxRetries:1,showToast:!1,operationTimeoutMs:6e4})}catch(o){throw ke(o)?(c.dismiss("withdraw"),new Error("Transaction cancelled")):await K(o)?new Error("Wallet session expired. Please reconnect and try again."):o}if(!a)throw new Error("Missing transaction hash after wallet confirmation");if(s&&await L({userId:s,walletAddress:d,txHash:a,type:"withdraw",status:"pending",amount:x}).catch(o=>{}),S("waiting"),C("Waiting for blockchain confirmation..."),c.loading("Waiting for confirmation...",{id:"withdraw"}),A&&(await Me(A,{hash:a,confirmations:1,timeout:18e4})).status==="reverted")throw new Error("Withdrawal transaction reverted on-chain");s&&await L({userId:s,walletAddress:d,txHash:a,type:"withdraw",status:"completed",amount:x}).catch(o=>{});const M=`${a.slice(0,6)}...${a.slice(-4)}`;if(c.success(t.jsxs("div",{className:"flex flex-col",children:[t.jsxs("span",{children:["Withdrew ",re(x),"!"]}),t.jsxs("a",{href:`https://sepolia.basescan.org/tx/${a}`,target:"_blank",rel:"noopener noreferrer",className:"text-xs text-blue-600 underline",children:["View tx: ",M]})]}),{id:"withdraw",duration:6e3}),s&&d)try{const o=ae();await fetch(`${o}/api/wallet/reconcile`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:s,walletAddress:d,txHash:a,txType:"withdraw",amountUSD:x})})}catch{}await je(1e3,"Post-withdraw settle"),Ce(B,{userId:s,txHash:a}),setTimeout(()=>{ee(),B.invalidateQueries({queryKey:["readContract"],exact:!1})},3e3),ee(),T.current&&(v(),m?.())}catch(h){const M=await K(h);if(a&&s&&!M){const N=I(h);await L({userId:s,walletAddress:d,txHash:a,type:"withdraw",status:"failed",amount:x,error:N.message}).catch(Xe=>{})}const o=I(h);j(o.message),M||c.error(`Withdrawal failed: ${o.message}`,{id:"withdraw"})}finally{H.current=!1,T.current&&(Q(!1),S("input"),C(""))}}const he=()=>_?Z?y==="simulating"?"Validating...":y==="withdrawing"?"Confirm in wallet...":y==="waiting"?"Waiting for confirmation...":"Withdraw":"Switch to Base":"Connect wallet",q=(()=>{switch(y){case"simulating":return{step:1,total:2,message:$||"Validating withdrawal..."};case"withdrawing":return{step:2,total:2,message:$||"Withdrawing USDC - confirm in wallet"};case"waiting":return{step:2,total:2,message:$||"Waiting for confirmation..."};default:return null}})();return t.jsxs("div",{className:"fixed inset-0 z-modal",children:[t.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:f?void 0:v}),t.jsxs("div",{className:"z-modal fixed inset-x-0 mx-auto w-full max-w-md rounded-t-2xl bg-white shadow-xl bottom-[calc(64px+env(safe-area-inset-bottom,0px))] max-h-[calc(100vh-env(safe-area-inset-top,0px)-64px-env(safe-area-inset-bottom,0px))] focus:outline-none",children:[t.jsx("div",{className:"mx-auto mt-2 mb-3 h-1.5 w-16 rounded-full bg-gray-200"}),t.jsxs("div",{className:"px-4 pb-3",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("h2",{className:"text-lg font-semibold",children:W}),t.jsx("button",{"aria-label":"Close",onClick:v,className:"rounded-full p-2 hover:bg-gray-100",disabled:f,children:"✕"})]}),t.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["Wallet: ",d?`${d.slice(0,6)}…${d.slice(-4)}`:"Not connected"," · Chain:"," ",k===g.id?"Base Sepolia":t.jsx("span",{className:"text-amber-600",children:"Switch to Base Sepolia"})]})]}),t.jsxs("div",{className:"overflow-y-auto pb-safe px-4 pt-3",children:[b.code!=="ready"&&t.jsx(Le,{className:"mb-4",tone:b.code==="session_unhealthy"?"error":"warning",title:"Wallet action required",message:b.message??"Update your wallet connection to continue.",actions:de}),G&&y==="input"&&t.jsxs("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg",children:[t.jsx("p",{className:"text-sm text-red-800",children:G}),t.jsx("button",{onClick:()=>j(null),className:"text-xs text-red-600 underline mt-1",children:"Dismiss"})]}),q&&t.jsxs("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-blue-600 border-t-transparent"}),t.jsxs("p",{className:"text-sm text-blue-900 font-medium",children:["Step ",q.step,"/",q.total,": ",q.message]})]}),y==="withdrawing"&&t.jsx("p",{className:"text-xs text-blue-700 mt-1",children:"Please check your wallet for the confirmation request"}),y==="waiting"&&t.jsx("p",{className:"text-xs text-blue-700 mt-1",children:"Transaction submitted, waiting for block confirmation..."})]}),t.jsx("label",{className:"mb-1 block text-sm font-medium",children:"Amount (USDC)"}),t.jsxs("div",{className:"mb-2 flex items-center gap-2",children:[t.jsxs("div",{className:"relative flex-1 min-w-0",children:[t.jsx("input",{inputMode:"decimal",pattern:"[0-9]*",value:D?String(D):"",onChange:s=>{const a=Number(s.target.value.replace(/[^\d.]/g,""));P(Number.isFinite(a)?a:0)},placeholder:"0.00",disabled:f,className:"w-full rounded-lg border border-gray-200 bg-white pl-3 pr-12 py-2 text-base outline-none ring-emerald-500 focus:ring-2 disabled:opacity-50 tabular-nums"}),t.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-500 whitespace-nowrap",children:"USDC"})]}),t.jsx("button",{type:"button",onClick:()=>P(z(l)),disabled:f,className:"rounded-lg border border-gray-200 px-3 py-2 text-xs font-semibold hover:bg-gray-50 disabled:opacity-50 whitespace-nowrap min-w-[56px]",children:"MAX"})]}),t.jsx("div",{className:"mb-1 text-xs text-gray-500",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{children:"Available to withdraw"}),t.jsx("span",{className:"font-medium text-gray-700 tabular-nums",children:re(l)})]})}),Y&&t.jsx("div",{className:"mb-3 text-xs font-medium text-red-600",children:"Insufficient balance"}),t.jsx("div",{className:"h-3"})]}),t.jsxs("div",{className:"sticky bottom-0 bg-white px-4 pt-3 pb-4 shadow-[0_-8px_24px_rgba(0,0,0,0.06)]",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("button",{onClick:v,className:"h-11 flex-1 rounded-xl border border-gray-200 font-medium hover:bg-gray-50 disabled:opacity-50",disabled:f,children:"Cancel"}),t.jsx("button",{onClick:we,className:"h-11 flex-1 rounded-xl bg-emerald-600 font-semibold text-white hover:bg-emerald-700 disabled:cursor-not-allowed disabled:opacity-50",disabled:ue,children:he()})]}),t.jsx("div",{className:"pb-safe"})]})]})]})}export{it as W,He as c,nt as u};
