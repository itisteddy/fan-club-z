import{r}from"./vendor-c36eaa8e.js";import{I as O,aD as z,N as H,l as w}from"./index-78beacc5.js";function _(A={}){const{session:e}=O(),{limit:v=20,autoRefresh:p=!0,refreshInterval:$=3e4}=A,m=z(t=>t.active),[j,k]=r.useState([]),[N,T]=r.useState(0),[y,b]=r.useState(!1),[R,C]=r.useState(null),[S,U]=r.useState(void 0),[E,x]=r.useState(!1),u=r.useRef(null),f=r.useRef(!0);r.useEffect(()=>(f.current=!0,()=>{f.current=!1,u.current&&clearTimeout(u.current)}),[]);const s=r.useCallback(async()=>{if(!e?.access_token){const{data:{session:t}}=await H.auth.getSession();return t?.access_token||null}return e.access_token},[e]),h=r.useCallback(async(t,o=!1)=>{if(!e){C(new Error("Not authenticated"));return}if(!m){b(!0),C(null);try{const a=await s();if(!a)throw new Error("No auth token available");const n=new URLSearchParams;n.set("limit",String(v)),t&&n.set("cursor",t);const i=w(),c=await fetch(`${i}/api/v2/notifications?${n.toString()}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},credentials:"include"});if(!c.ok){const g=await c.json().catch(()=>({}));throw new Error(g?.message||`HTTP error! status: ${c.status}`)}const d=await c.json();if(!f.current)return;k(o?g=>[...g,...d.items]:d.items),T(d.unreadCount||0),U(d.nextCursor),x(!!d.nextCursor)}catch(a){if(!f.current)return;const n=a instanceof Error?a:new Error("Failed to fetch notifications");C(n)}finally{f.current&&b(!1)}}},[e,v,s]),l=r.useCallback(async()=>{if(e&&!m)try{const t=await s();if(!t)return;const o=w(),a=await fetch(`${o}/api/v2/notifications?limit=1`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},credentials:"include"});if(a.ok){const n=await a.json();f.current&&T(n.unreadCount||0)}}catch{}},[e,s]),P=r.useCallback(async t=>{if(!(!e||t.length===0)&&!m)try{const o=await s();if(!o)throw new Error("No auth token available");const a=w(),n=await fetch(`${a}/api/v2/notifications/mark-read`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},credentials:"include",body:JSON.stringify({ids:t})});if(!n.ok){const i=await n.json().catch(()=>({}));throw new Error(i?.message||`HTTP error! status: ${n.status}`)}k(i=>i.map(c=>t.includes(c.id)?{...c,readAt:new Date().toISOString()}:c)),T(i=>Math.max(0,i-t.length)),await l()}catch(o){throw o}},[e,s,l]),B=r.useCallback(async()=>{if(e&&!m)try{const t=await s();if(!t)throw new Error("No auth token available");const o=w(),a=await fetch(`${o}/api/v2/notifications/mark-all-read`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},credentials:"include"});if(!a.ok){const n=await a.json().catch(()=>({}));throw new Error(n?.message||`HTTP error! status: ${a.status}`)}k(n=>n.map(i=>({...i,readAt:new Date().toISOString()}))),T(0)}catch(t){throw t}},[e,s]),D=r.useCallback(()=>{E&&S&&!y&&h(S,!0)},[E,S,y,h]);r.useEffect(()=>{e&&h()},[e]),r.useEffect(()=>{if(!p||!e)return;const t=()=>{l()};return window.addEventListener("focus",t),()=>window.removeEventListener("focus",t)},[p,e,l]),r.useEffect(()=>{if(!p||!e)return;const t=()=>{u.current&&clearTimeout(u.current),u.current=setTimeout(()=>{f.current&&(l(),t())},$)};return t(),()=>{u.current&&clearTimeout(u.current)}},[p,e,$,l]);const M=r.useCallback(async()=>{if(e)try{const t=await s();if(!t)return;const o=w(),a=await fetch(`${o}/api/v2/notifications/reminders/sync`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},credentials:"include"});a.ok&&(await a.json()).created>0&&await h()}catch{}},[e,s,h]);return{notifications:j,unreadCount:N,loading:y,error:R,hasMore:E,fetchNotifications:()=>h(),refreshUnreadCount:l,markRead:P,markAllRead:B,loadMore:D,syncReminders:M}}export{_ as u};
