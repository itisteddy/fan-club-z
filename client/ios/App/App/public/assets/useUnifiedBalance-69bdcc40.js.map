{"version":3,"file":"useUnifiedBalance-69bdcc40.js","sources":["../../src/hooks/useWalletSummary.ts","../../src/hooks/useUnifiedBalance.ts"],"sourcesContent":["import { useQuery } from '@tanstack/react-query';\nimport { QK } from '@/lib/queryKeys';\nimport { getApiUrl } from '@/utils/environment';\n\nexport type WalletSummary = {\n  currency: 'USD';\n  available: number;\n  reserved: number;\n  total: number;\n  availableToStakeUSDC: number;\n  reservedUSDC: number;\n  escrowUSDC: number;\n  totalDeposited?: number;\n  totalWithdrawn?: number;\n  updatedAt: string;\n  walletAddress?: string | null;\n};\n\ntype WalletSummaryOptions = {\n  walletAddress?: string | null;\n  enabled?: boolean;\n  refetchIntervalMs?: number;\n};\n\n/**\n * Hook to fetch wallet summary from the server\n * \n * PERFORMANCE FIX v2:\n * - Default refetch interval increased to 30s (was 10s)\n * - Added staleTime and gcTime for better caching\n * - Disabled refetchOnWindowFocus\n */\nexport function useWalletSummary(userId?: string, options: WalletSummaryOptions = {}) {\n  // PERFORMANCE FIX: Default interval increased from 10s to 30s\n  const { walletAddress, enabled = true, refetchIntervalMs = 30_000 } = options;\n  const walletAddr = walletAddress?.toLowerCase() ?? null;\n\n  return useQuery({\n    queryKey: QK.walletSummary(userId ?? 'anon', walletAddr),\n    enabled: Boolean(userId) && enabled,\n    refetchInterval: refetchIntervalMs,\n    // PERFORMANCE FIX: Better caching settings\n    staleTime: 20_000, // Data fresh for 20 seconds\n    gcTime: 60_000, // Keep in cache for 1 minute\n    refetchOnWindowFocus: false,\n    refetchOnMount: false,\n    retry: 2,\n    queryFn: async (): Promise<WalletSummary> => {\n      if (!userId) {\n        throw new Error('userId is required to load wallet summary');\n      }\n\n      const params = new URLSearchParams();\n      if (walletAddr) {\n        params.set('walletAddress', walletAddr);\n      }\n\n      const apiBase = getApiUrl();\n      // CRITICAL: Add a timeout so a stalled network request can't leave the wallet in a\n      // permanent \"Loading...\" state (some users reported infinite loading).\n      const controller = new AbortController();\n      const timeout = setTimeout(() => controller.abort(), 12_000);\n      const url = `${apiBase}/api/wallet/summary/${userId}${params.size ? `?${params.toString()}` : ''}`;\n\n      let response: Response;\n      try {\n        response = await fetch(url, {\n          headers: {\n            Accept: 'application/json',\n          },\n          signal: controller.signal,\n        });\n      } catch (e: any) {\n        if (e?.name === 'AbortError') {\n          throw new Error('Wallet summary request timed out. Please try again.');\n        }\n        throw e;\n      } finally {\n        clearTimeout(timeout);\n      }\n\n      if (!response.ok) {\n        const errorBody = await response.json().catch(() => ({}));\n        throw new Error(errorBody.message || 'Failed to load wallet summary');\n      }\n\n      const summary = await response.json();\n\n      return {\n        currency: 'USD',\n        available: Number(summary.available ?? 0),\n        reserved: Number(summary.reserved ?? 0),\n        total: Number(summary.total ?? 0),\n        availableToStakeUSDC: Number(summary.availableToStakeUSDC ?? summary.available ?? 0),\n        reservedUSDC: Number(summary.reservedUSDC ?? summary.reserved ?? 0),\n        escrowUSDC: Number(summary.escrowUSDC ?? summary.total ?? 0),\n        totalDeposited: Number(summary.totalDeposited ?? summary.totalDepositedUSDC ?? 0),\n        totalWithdrawn: Number(summary.totalWithdrawn ?? summary.totalWithdrawnUSDC ?? 0),\n        updatedAt: summary.updatedAt ?? summary.updated_at ?? new Date().toISOString(),\n        walletAddress: summary.walletAddress ?? summary.wallet_address ?? null,\n      };\n    }\n  });\n}\n","import { useEffect, useRef } from 'react';\nimport { useQueryClient } from '@tanstack/react-query';\nimport { useEscrowBalance } from './useEscrowBalance';\nimport { useUSDCBalance } from './useUSDCBalance';\nimport { useAccount } from 'wagmi';\nimport { useAuthStore } from '@/store/authStore';\nimport { useWalletSummary } from './useWalletSummary';\n\n/**\n * Unified balance hook that combines wallet and escrow balances\n * This is the SINGLE SOURCE OF TRUTH for all balance displays\n */\nexport function useUnifiedBalance() {\n  const { user } = useAuthStore();\n  const { address } = useAccount();\n  const queryClient = useQueryClient();\n\n  const { balance: walletUSDC, isLoading: walletLoading, error: walletError, refetch: refetchWallet } = useUSDCBalance();\n  const {\n    availableUSD,\n    reservedUSD,\n    totalUSD,\n    isLoading: escrowLoading,\n    error: escrowError,\n    refetch: refetchEscrow\n  } = useEscrowBalance();\n\n  const {\n    data: summary,\n    isLoading: summaryLoading,\n    error: summaryError,\n    refetch: refetchSummary\n  } = useWalletSummary(user?.id, {\n    walletAddress: address,\n    refetchIntervalMs: 30_000, // Reduced from 10s to 30s to prevent excessive refetching\n    enabled: Boolean(user?.id)\n  });\n\n  const onchainBalance = typeof availableUSD === 'number' ? availableUSD : 0;\n  const onchainReserved = typeof reservedUSD === 'number' ? reservedUSD : 0;\n  const onchainTotal =\n    typeof totalUSD === 'number' && !Number.isNaN(totalUSD)\n      ? totalUSD\n      : onchainBalance + onchainReserved;\n\n  const summaryAvailable = Number(summary?.availableToStakeUSDC ?? summary?.available ?? 0);\n  const summaryReserved = Number(summary?.reservedUSDC ?? summary?.reserved ?? 0);\n  const summaryEscrow = Number(summary?.escrowUSDC ?? 0);\n  const summaryTotal =\n    typeof summaryAvailable === 'number' && typeof summaryReserved === 'number'\n      ? summaryAvailable + summaryReserved\n      : 0;\n  const hasLoadedSummary = !!summary && !summaryLoading && !summaryError;\n\n  // CRITICAL ARCHITECTURE DECISION:\n  // - Available balance for staking MUST come from walletSummary (reconcileWallet),\n  //   because it subtracts consumed locks for active bets.\n  // - On-chain escrow contract does NOT know about off-chain locks, so its balance\n  //   will not decrease when you stake on a prediction.\n  //\n  // Therefore:\n  // - When summary is available → trust summary.availableToStakeUSDC completely.\n  // - When summary is NOT available (e.g. initial load, error) → fall back to on-chain.\n  //\n  // This guarantees:\n  // - After stake: available decreases correctly (because locks are counted in summary).\n  // - After settlement/unlock: available increases correctly when locks are released.\n\n  const computedAvailable = hasLoadedSummary\n    ? Math.max(0, summaryAvailable)\n    : Math.max(0, onchainBalance);\n\n  // Reserved balance: prefer summary (locks), fall back to on-chain reserved snapshot\n  const computedReserved = hasLoadedSummary\n    ? Math.max(0, summaryReserved)\n    : Math.max(0, onchainReserved);\n\n  // Total escrow: prefer summaryEscrow (which reflects reconciled view), fall back to on-chain\n  const computedTotal = hasLoadedSummary\n    ? Math.max(0, summaryEscrow || summaryTotal || onchainTotal)\n    : Math.max(0, onchainTotal);\n\n  const normalizedAvailable = Math.max(computedAvailable, 0);\n  const normalizedReserved = Math.max(computedReserved, 0);\n  const normalizedTotal = Math.max(computedTotal, 0);\n\n  const lastValuesRef = useRef({ available: normalizedAvailable, reserved: normalizedReserved, total: normalizedTotal });\n\n  useEffect(() => {\n    lastValuesRef.current = {\n      available: normalizedAvailable,\n      reserved: normalizedReserved,\n      total: normalizedTotal\n    };\n  }, [normalizedAvailable, normalizedReserved, normalizedTotal]);\n\n  const isLoading = walletLoading || escrowLoading || summaryLoading;\n\n  const available = isLoading ? lastValuesRef.current.available : normalizedAvailable;\n  const reserved = isLoading ? lastValuesRef.current.reserved : normalizedReserved;\n  const total = isLoading ? lastValuesRef.current.total : normalizedTotal;\n\n  const refetchAll = () => {\n    refetchWallet();\n    refetchEscrow();\n    if (user?.id) {\n      void refetchSummary();\n    }\n  };\n\n  // Listen for balance refresh events - CRITICAL: Force immediate refetch\n  useEffect(() => {\n    const handleRefresh = () => {\n      console.log('[FCZ-PAY] Balance refresh event received, forcing immediate refetch');\n      // Invalidate React Query cache first to force fresh data (bypasses staleTime)\n      queryClient.invalidateQueries({ queryKey: ['readContract'], exact: false });\n      queryClient.invalidateQueries({ queryKey: ['wallet'], exact: false });\n      queryClient.invalidateQueries({ queryKey: ['escrow-balance'], exact: false });\n      queryClient.invalidateQueries({ queryKey: ['usdcBalance'], exact: false });\n      // Then immediately refetch all balances (forces network request)\n      refetchAll();\n    };\n    \n    window.addEventListener('fcz:balance:refresh', handleRefresh);\n    return () => window.removeEventListener('fcz:balance:refresh', handleRefresh);\n  }, [queryClient, refetchWallet, refetchEscrow, refetchSummary, user?.id]); // eslint-disable-line react-hooks/exhaustive-deps\n\n  return {\n    wallet: walletUSDC || 0,\n    available,\n    locked: reserved,\n    total,\n    summary,\n    isLoading,\n    isWalletLoading: walletLoading,\n    isEscrowLoading: escrowLoading,\n    error: walletError || escrowError || summaryError,\n    walletError,\n    escrowError,\n    summaryError,\n    refetch: refetchAll,\n    refetchWallet,\n    refetchEscrow,\n    refetchSummary\n  };\n}\n"],"names":["useWalletSummary","userId","options","walletAddress","enabled","refetchIntervalMs","walletAddr","useQuery","QK","params","apiBase","getApiUrl","controller","timeout","url","response","e","errorBody","summary","useUnifiedBalance","user","useAuthStore","address","useAccount","queryClient","useQueryClient","walletUSDC","walletLoading","walletError","refetchWallet","useUSDCBalance","availableUSD","reservedUSD","totalUSD","escrowLoading","escrowError","refetchEscrow","useEscrowBalance","summaryLoading","summaryError","refetchSummary","onchainBalance","onchainReserved","onchainTotal","summaryAvailable","summaryReserved","summaryEscrow","summaryTotal","hasLoadedSummary","computedAvailable","computedReserved","computedTotal","normalizedAvailable","normalizedReserved","normalizedTotal","lastValuesRef","useRef","useEffect","isLoading","available","reserved","total","refetchAll","handleRefresh"],"mappings":"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"}