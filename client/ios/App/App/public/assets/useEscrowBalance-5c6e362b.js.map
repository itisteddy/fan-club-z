{"version":3,"file":"useEscrowBalance-5c6e362b.js","sources":["../../src/hooks/useEscrowBalance.ts"],"sourcesContent":["import { useReadContract, useAccount } from 'wagmi';\nimport { baseSepolia } from 'wagmi/chains';\nimport { getAddress } from 'viem';\nimport { useEffect } from 'react';\n\n// Escrow Contract Address - MUST come from env, never hardcoded\nfunction resolveEscrowAddress(): `0x${string}` {\n  const primary = import.meta.env.VITE_BASE_ESCROW_ADDRESS;\n  const legacy = import.meta.env.VITE_ESCROW_ADDRESS_BASE_SEPOLIA;\n  if (primary && legacy && primary.trim().toLowerCase() !== legacy.trim().toLowerCase()) {\n    // Hard guard: refuse to silently choose between two different escrow addresses.\n    throw new Error(\n      `[FCZ-PAY] Escrow address mismatch. VITE_BASE_ESCROW_ADDRESS (${primary}) !== VITE_ESCROW_ADDRESS_BASE_SEPOLIA (${legacy}). Fix env to a single canonical escrow.`\n    );\n  }\n  const raw = primary ?? legacy;\n\n  if (!raw) {\n    // Fail fast and surface configuration issue in console\n    console.error(\n      '[FCZ-PAY] Escrow address not configured. Set VITE_BASE_ESCROW_ADDRESS in Vercel env.'\n    );\n    throw new Error('Escrow address not configured');\n  }\n\n  const checksummed = getAddress(raw as `0x${string}`);\n  return checksummed as `0x${string}`;\n}\n\nconst ESCROW_ADDRESS = resolveEscrowAddress();\n\n// Escrow ABI - just the functions we need to read balances\nconst ESCROW_ABI = [\n  {\n    type: 'function',\n    name: 'balances',\n    stateMutability: 'view',\n    inputs: [{ name: 'user', type: 'address' }],\n    outputs: [{ type: 'uint256' }],\n  },\n  {\n    type: 'function',\n    name: 'reserved',\n    stateMutability: 'view',\n    inputs: [{ name: 'user', type: 'address' }],\n    outputs: [{ type: 'uint256' }],\n  },\n] as const;\n\n/**\n * Hook to read user's escrow balance from the smart contract\n * Returns available balance, reserved balance, and loading state\n * \n * PERFORMANCE FIX v2: Reduced refetch frequency to improve app performance\n */\nexport function useEscrowBalance() {\n  const { address, isConnected, chainId } = useAccount();\n\n  const persistedAddress = typeof window !== 'undefined' ? getPersistedAddress() : undefined;\n  const effectiveAddress = address ?? persistedAddress;\n  \n  // CRITICAL FIX: Enable query even if chainId is undefined during hydration\n  // We know we're on Base Sepolia if we have an address (from persisted state or connected)\n  const isEnabled = !!effectiveAddress && (chainId === baseSepolia.id || chainId === undefined);\n\n  // AGGRESSIVE DEBUGGING\n  if (typeof window !== 'undefined') {\n    console.log('[FCZ-PAY] useEscrowBalance state:', {\n      address,\n      persistedAddress,\n      effectiveAddress,\n      chainId,\n      isEnabled,\n      escrowAddress: ESCROW_ADDRESS,\n    });\n  }\n\n  // Read available balance (user's escrow balance)\n  const { data: availableBalance, isLoading: isLoadingAvailable, error: errorAvailable, refetch: refetchAvailable } = useReadContract({\n    address: ESCROW_ADDRESS,\n    abi: ESCROW_ABI,\n    functionName: 'balances',\n    args: effectiveAddress ? [effectiveAddress] : undefined,\n    query: {\n      enabled: isEnabled,\n      // CRITICAL FIX: Force refetch on mount to ensure we get latest balance\n      refetchOnMount: true,\n      refetchInterval: 10_000, // Refetch every 10 seconds for faster updates\n      staleTime: 5_000, // Data considered fresh for only 5 seconds\n      gcTime: 30_000, // Keep in cache for 30 seconds\n      retry: 3, // More retries\n      refetchOnWindowFocus: true, // Refetch when user returns to tab\n    },\n  });\n\n  // Read reserved balance (funds locked in active predictions)\n  const { data: reservedBalance, isLoading: isLoadingReserved, error: errorReserved, refetch: refetchReserved } = useReadContract({\n    address: ESCROW_ADDRESS,\n    abi: ESCROW_ABI,\n    functionName: 'reserved',\n    args: effectiveAddress ? [effectiveAddress] : undefined,\n    query: {\n      enabled: isEnabled,\n      // CRITICAL FIX: Force refetch on mount to ensure we get latest balance\n      refetchOnMount: true,\n      refetchInterval: 10_000, // Refetch every 10 seconds for faster updates\n      staleTime: 5_000, // Data considered fresh for only 5 seconds\n      gcTime: 30_000, // Keep in cache for 30 seconds\n      retry: 3, // More retries\n      refetchOnWindowFocus: true, // Refetch when user returns to tab\n    },\n  });\n\n  // Convert from wei (6 decimals for USDC) to USD\n  const availableUSD = availableBalance ? Number(availableBalance) / 1_000_000 : 0;\n  const reservedUSD = reservedBalance ? Number(reservedBalance) / 1_000_000 : 0;\n  const totalUSD = availableUSD + reservedUSD;\n\n  // AGGRESSIVE DEBUGGING - Always log in production too for troubleshooting\n  if (typeof window !== 'undefined' && isEnabled) {\n    console.log('[FCZ-PAY] Escrow balance (on-chain):', {\n      effectiveAddress,\n      availableBalance: availableBalance?.toString(),\n      reservedBalance: reservedBalance?.toString(),\n      availableUSD,\n      reservedUSD,\n      totalUSD,\n      isLoadingAvailable,\n      isLoadingReserved,\n      errorAvailable: errorAvailable?.message,\n      errorReserved: errorReserved?.message,\n    });\n  }\n\n  const isLoading = isLoadingAvailable || isLoadingReserved;\n  const error = errorAvailable || errorReserved;\n\n  const refetch = async () => {\n    await Promise.all([refetchAvailable(), refetchReserved()]);\n  };\n\n  // CRITICAL FIX: Force immediate refetch when address becomes available\n  useEffect(() => {\n    if (isEnabled && effectiveAddress) {\n      // Small delay to ensure wagmi is ready\n      const timer = setTimeout(() => {\n        console.log('[FCZ-PAY] Forcing escrow balance refetch for:', effectiveAddress);\n        refetch();\n      }, 500);\n      return () => clearTimeout(timer);\n    }\n  }, [isEnabled, effectiveAddress]); // eslint-disable-line react-hooks/exhaustive-deps\n\n  return {\n    // Raw values (in USDC units - 6 decimals)\n    availableBalance: availableBalance || BigInt(0),\n    reservedBalance: reservedBalance || BigInt(0),\n    \n    // USD values (human-readable)\n    availableUSD,\n    reservedUSD,\n    totalUSD,\n    \n    // State\n    isLoading,\n    error,\n    refetch,\n    \n    // Connection state\n    isConnected,\n    chainId,\n    isCorrectChain: chainId === baseSepolia.id,\n  };\n}\n\nfunction getPersistedAddress(): `0x${string}` | undefined {\n  try {\n    const store = localStorage.getItem('wagmi.store');\n    if (!store) return undefined;\n    const parsed = JSON.parse(store);\n    const connections = parsed?.state?.connections?.value;\n    const current = parsed?.state?.current;\n    if (current && Array.isArray(connections)) {\n      const match = connections.find(\n        (entry: any) => Array.isArray(entry) && entry[0] === current && entry[1]?.accounts?.length\n      );\n      if (match) {\n        return match[1].accounts[0] as `0x${string}`;\n      }\n    }\n    if (Array.isArray(connections)) {\n      for (const entry of connections) {\n        if (Array.isArray(entry) && entry[1]?.accounts?.length) {\n          return entry[1].accounts[0] as `0x${string}`;\n        }\n      }\n    }\n  } catch {\n    // Ignore store errors\n  }\n  return undefined;\n}\n"],"names":["resolveEscrowAddress","primary","legacy","getAddress","ESCROW_ADDRESS","ESCROW_ABI","useEscrowBalance","address","isConnected","chainId","useAccount","persistedAddress","getPersistedAddress","effectiveAddress","isEnabled","baseSepolia","availableBalance","isLoadingAvailable","errorAvailable","refetchAvailable","useReadContract","reservedBalance","isLoadingReserved","errorReserved","refetchReserved","availableUSD","reservedUSD","totalUSD","isLoading","error","refetch","useEffect","timer","store","parsed","connections","current","match","entry"],"mappings":"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"}