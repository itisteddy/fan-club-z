{"version":3,"file":"CreatorByline-9bede90f.js","sources":["../../src/features/images/queries.ts","../../src/features/images/cache.ts","../../src/features/images/StableImageProvider.tsx","../../src/hooks/useMedia.ts","../../src/lib/users.ts","../../src/components/predictions/CreatorByline.tsx"],"sourcesContent":["// Keyword extraction and query building utilities\n\nexport type PredictionContext = {\n  title: string;\n  category?: string;\n  description?: string;\n  question?: string | null;\n  tags?: string[];\n  options?: Array<{ label?: string | null } | null | undefined>;\n  entry_deadline?: string | null;\n  keywords?: string[];\n  attributes?: string[];\n  identity?: {\n    creator?: string | null;\n    community?: string | null;\n    personas?: string[];\n  };\n  popularity?: {\n    pool?: number | null;\n    players?: number | null;\n    totalVolume?: number | null;\n    score?: number | null;\n    likes?: number | null;\n    comments?: number | null;\n  };\n};\n\nconst STOPWORDS = new Set([\n  'the', 'a', 'an', 'of', 'is', 'are', 'to', 'in', 'by', 'on', 'for', 'with', 'will',\n  'be', 'have', 'has', 'had', 'do', 'does', 'did', 'can', 'could', 'should', 'would',\n  'may', 'might', 'must', 'shall', 'this', 'that', 'these', 'those', 'i', 'you', 'he',\n  'she', 'it', 'we', 'they', 'me', 'him', 'her', 'us', 'them', 'my', 'your', 'his',\n  'her', 'its', 'our', 'their', 'mine', 'yours', 'hers', 'ours', 'theirs'\n]);\n\nconst MAX_KEYWORDS = 8;\n\nfunction extractKeywords(text?: string, limit = 4): string[] {\n  if (!text) return [];\n\n  return text\n    .toLowerCase()\n    .replace(/[^\\p{L}\\p{N}\\s]/gu, '') // Remove punctuation, keep letters and numbers\n    .split(/\\s+/)\n    .filter(word => word && !STOPWORDS.has(word))\n    .slice(0, limit);\n}\n\nexport function keywordsFromTitle(title: string): string[] {\n  return extractKeywords(title);\n}\n\n// Category to query template mapping\nconst CATEGORY_QUERIES: Record<string, string> = {\n  tech: 'technology gadgets computer',\n  technology: 'technology gadgets computer',\n  sports: 'sports stadium athlete',\n  crypto: 'cryptocurrency blockchain digital',\n  cryptocurrency: 'cryptocurrency blockchain digital',\n  politics: 'government parliament politics',\n  business: 'business office corporate',\n  entertainment: 'entertainment media celebrity',\n  science: 'science laboratory research',\n  health: 'health medical wellness',\n  finance: 'finance money investment',\n  education: 'education learning school',\n  travel: 'travel destination landscape',\n  food: 'food cooking restaurant',\n  fashion: 'fashion style clothing',\n  art: 'art creative design',\n  music: 'music concert performance',\n  gaming: 'gaming esports technology',\n  automotive: 'car automotive vehicle',\n  real_estate: 'house building architecture'\n};\n\nconst ENTITY_OVERRIDES: Array<{ keywords: string[]; query: string }> = [\n  { keywords: ['taylor swift'], query: 'taylor swift singer portrait pop star' },\n  { keywords: ['beyonce'], query: 'beyonce singer concert stage lights' },\n  { keywords: ['super bowl'], query: 'super bowl american football crowd stadium' },\n  { keywords: ['nba', 'lakers', 'celtics', 'warriors'], query: 'nba basketball arena game action' },\n  { keywords: ['bitcoin'], query: 'bitcoin cryptocurrency coin digital gold' },\n  { keywords: ['ethereum'], query: 'ethereum blockchain technology crypto' },\n  { keywords: ['tesla'], query: 'tesla electric car futuristic automotive' },\n  { keywords: ['apple', 'iphone', 'macbook'], query: 'apple product render minimalist tech' },\n  { keywords: ['marvel', 'avengers'], query: 'marvel movie cinematic superhero film poster' },\n  // Brand-aware override so Fanclubz predictions feel on-brand instead of generic stadiums\n  {\n    keywords: ['fanclubz', 'fan club z'],\n    query: 'mobile app interface prediction cards clean ui analytics dashboard soft gradient'\n  }\n];\n\ntype ThemeRule = {\n  pattern: RegExp;\n  enrichment: string;\n};\n\nconst THEME_RULES: ThemeRule[] = [\n  {\n    pattern: /\\b(playstation|xbox|nintendo|switch|console|gaming|esports|ps[45]|fc\\d+|fifa|call of duty|madden)\\b/i,\n    enrichment: 'gaming console controller neon lights'\n  },\n  {\n    pattern: /\\b(soccer|football|premier league|champions league|world cup|uefa|goal|striker|super eagles|laliga|serie a)\\b/i,\n    enrichment: 'soccer football stadium crowd energy'\n  },\n  {\n    // Nigeria / Super Eagles specific football enrichment so we bias toward stadium imagery,\n    // not generic city skylines, for these predictions.\n    pattern: /\\b(super eagles|nigeria national football team|nigerian national team)\\b/i,\n    enrichment: 'nigeria football super eagles national team stadium match night lights crowd'\n  },\n  {\n    pattern: /\\b(nba|basketball|wnba|lebron|curry|lakers|warriors|celtics|bucks|slam dunk)\\b/i,\n    enrichment: 'basketball court arena spotlight action'\n  },\n  {\n    pattern: /\\b(baseball|mlb|yankees|mets|dodgers|home run)\\b/i,\n    enrichment: 'baseball stadium diamond night lights'\n  },\n  {\n    pattern: /\\b(crypto|bitcoin|ethereum|blockchain|token|defi|web3|nft)\\b/i,\n    enrichment: 'cryptocurrency blockchain digital finance'\n  },\n  {\n    pattern: /\\b(stock|market|nasdaq|dow|s&p|economy|inflation|interest rate|fed|earnings)\\b/i,\n    enrichment: 'finance stock market trading screens'\n  },\n  {\n    pattern: /\\b(election|vote|president|senate|congress|ballot|campaign|debate|primary)\\b/i,\n    enrichment: 'politics debate stage voters flag'\n  },\n  {\n    pattern: /\\b(ai|artificial intelligence|machine learning|automation|robot|chatgpt|openai)\\b/i,\n    enrichment: 'artificial intelligence neon interface'\n  },\n  {\n    pattern: /\\b(weather|storm|hurricane|rain|snow|heatwave|forecast|climate|temperature)\\b/i,\n    enrichment: 'weather radar satellite dramatic sky'\n  },\n  {\n    pattern: /\\b(health|medical|hospital|doctor|vaccine|covid|virus|pharma|therapy)\\b/i,\n    enrichment: 'healthcare medical laboratory professional'\n  },\n  {\n    pattern: /\\b(movie|film|netflix|disney|hollywood|oscars|series|streaming|celebrity|album|music)\\b/i,\n    enrichment: 'entertainment cinematic lights audience'\n  },\n  {\n    pattern: /\\b(travel|flight|airline|airport|tourism|hotel|vacation|cruise|passport)\\b/i,\n    enrichment: 'travel adventure airplane tropical destination'\n  },\n  {\n    pattern: /\\b(oil|gas|energy|petroleum|solar|wind|renewable|power grid|battery)\\b/i,\n    enrichment: 'energy industry infrastructure power'\n  },\n  {\n    pattern: /\\b(education|school|university|college|students|teacher|campus|graduation)\\b/i,\n    enrichment: 'education classroom lecture modern campus'\n  },\n  {\n    pattern: /\\b(military|war|defense|army|navy|missile|conflict|ukraine|gaza|troops)\\b/i,\n    enrichment: 'military strategy defense technology'\n  }\n];\n\nfunction buildTextHaystack(prediction: PredictionContext): string {\n  const identityValues = [\n    prediction.identity?.creator,\n    prediction.identity?.community,\n    ...(prediction.identity?.personas ?? []),\n  ];\n\n  const popularityDescriptors = [\n    prediction.popularity?.players ? `${prediction.popularity.players} participants` : '',\n    prediction.popularity?.pool ? `${prediction.popularity.pool} stake` : '',\n    prediction.popularity?.totalVolume ? `${prediction.popularity.totalVolume} volume` : '',\n  ];\n\n  return [\n    prediction.title,\n    prediction.description,\n    prediction.question,\n    ...(prediction.options?.map(opt => opt?.label ?? '') ?? []),\n    ...(prediction.tags ?? []),\n    ...(prediction.keywords ?? []),\n    ...(prediction.attributes ?? []),\n    ...identityValues,\n    ...popularityDescriptors,\n  ]\n    .filter(Boolean)\n    .join(' ')\n    .toLowerCase();\n}\n\nfunction matchEntityOverride(prediction: PredictionContext): string | null {\n  const haystack = buildTextHaystack(prediction);\n\n  for (const override of ENTITY_OVERRIDES) {\n    if (override.keywords.some(keyword => haystack.includes(keyword))) {\n      return override.query;\n    }\n  }\n\n  return null;\n}\n\nfunction getThemeEnrichments(prediction: PredictionContext): string[] {\n  const haystack = buildTextHaystack(prediction);\n  const enrichments = new Set<string>();\n\n  for (const rule of THEME_RULES) {\n    if (rule.pattern.test(haystack)) {\n      enrichments.add(rule.enrichment);\n    }\n  }\n\n  return Array.from(enrichments);\n}\n\nfunction detectYear(prediction: PredictionContext): string | null {\n  const sources = [\n    prediction.title,\n    prediction.description,\n    prediction.entry_deadline\n  ].filter(Boolean) as string[];\n\n  for (const source of sources) {\n    const match = source.match(/20\\d{2}/);\n    if (match) {\n      return match[0];\n    }\n  }\n\n  return null;\n}\n\nfunction addKeywords(target: Set<string>, words: string[] = []) {\n  for (const word of words) {\n    if (!word) continue;\n    if (word.length <= 2 && !/^\\d+$/.test(word)) continue; // skip tiny words unless numeric (years)\n    target.add(word);\n  }\n}\n\nfunction normalizeNumber(value?: number | string | null): number | null {\n  if (typeof value === 'number' && !Number.isNaN(value)) {\n    return value;\n  }\n  if (typeof value === 'string') {\n    const numeric = parseFloat(value.replace(/[^\\d.]/g, ''));\n    return Number.isNaN(numeric) ? null : numeric;\n  }\n  return null;\n}\n\nfunction popularityKeywords(popularity?: PredictionContext['popularity']): string[] {\n  if (!popularity) return [];\n  const keywords: string[] = [];\n\n  const pool = normalizeNumber(popularity.pool ?? popularity.totalVolume);\n  const players = normalizeNumber(popularity.players);\n  const score = normalizeNumber(popularity.score);\n  const comments = normalizeNumber(popularity.comments);\n  const likes = normalizeNumber(popularity.likes);\n\n  if (pool && pool >= 10000) {\n    keywords.push('high stakes spotlight premium');\n  } else if (pool && pool >= 2000) {\n    keywords.push('high stakes trending excitement');\n  }\n\n  if (players && players >= 100) {\n    keywords.push('massive crowd fans community buzz');\n  } else if (players && players >= 20) {\n    keywords.push('community challenge social energy');\n  }\n\n  if (score && score >= 70) {\n    keywords.push('viral trend spotlight momentum');\n  }\n\n  if (comments && comments >= 25) {\n    keywords.push('heated debate discussion panel');\n  }\n\n  if (likes && likes >= 50) {\n    keywords.push('fan favorite popular culture');\n  }\n\n  return keywords;\n}\n\nexport function buildImageQuery(prediction: PredictionContext): string {\n  const override = matchEntityOverride(prediction);\n  if (override) {\n    return override;\n  }\n\n  const keywordSet = new Set<string>();\n  addKeywords(keywordSet, extractKeywords(prediction.title, 5));\n  addKeywords(keywordSet, extractKeywords(prediction.description, 3));\n  addKeywords(keywordSet, extractKeywords(prediction.question ?? '', 3));\n  addKeywords(keywordSet, prediction.tags ?? []);\n  addKeywords(\n    keywordSet,\n    prediction.options\n      ?.map(opt => extractKeywords(opt?.label ?? '', 2))\n      .flat()\n      .filter(Boolean) ?? []\n  );\n  addKeywords(keywordSet, prediction.keywords ?? []);\n  addKeywords(keywordSet, prediction.attributes ?? []);\n  addKeywords(keywordSet, prediction.identity?.personas ?? []);\n  addKeywords(keywordSet, extractKeywords(prediction.identity?.creator ?? '', 2));\n  addKeywords(keywordSet, extractKeywords(prediction.identity?.community ?? '', 2));\n  addKeywords(keywordSet, popularityKeywords(prediction.popularity));\n\n  const year = detectYear(prediction);\n  if (year) {\n    keywordSet.add(year);\n  }\n\n  if (prediction.category) {\n    const normalizedCategory = prediction.category.replace('_', ' ').toLowerCase();\n    keywordSet.add(normalizedCategory);\n\n    const categoryQuery = CATEGORY_QUERIES[normalizedCategory];\n    if (categoryQuery) {\n      addKeywords(keywordSet, categoryQuery.split(' '));\n    }\n  }\n\n  const themeEnrichments = getThemeEnrichments(prediction);\n  themeEnrichments.forEach(phrase => addKeywords(keywordSet, phrase.split(' ')));\n\n  const keywords = Array.from(keywordSet).slice(0, MAX_KEYWORDS);\n\n  if (keywords.length >= 2) {\n    return keywords.join(' ');\n  }\n\n  const fallbackCategory = prediction.category\n    ? CATEGORY_QUERIES[prediction.category.toLowerCase()] ?? prediction.category.toLowerCase()\n    : null;\n\n  if (fallbackCategory) {\n    return fallbackCategory;\n  }\n\n  return 'abstract business technology';\n}\n\n// Generate deterministic seed from prediction data\nexport function generateSeed(prediction: {\n  id?: string;\n  slug?: string;\n  title: string;\n}): string {\n  return prediction.id || prediction.slug || prediction.title.trim().toLowerCase();\n}\n\n// Validate and sanitize query for safety\nexport function sanitizeQuery(query: string): string {\n  // Remove potentially problematic terms\n  const blocklist = [\n    'explicit', 'nsfw', 'adult', 'nude', 'naked', 'sex', 'porn',\n    'violence', 'blood', 'gore', 'weapon', 'gun', 'knife',\n    'hate', 'racist', 'offensive'\n  ];\n\n  let sanitized = query.toLowerCase();\n  \n  for (const term of blocklist) {\n    sanitized = sanitized.replace(new RegExp(`\\\\b${term}\\\\b`, 'gi'), '');\n  }\n\n  // Clean up extra spaces\n  sanitized = sanitized.replace(/\\s+/g, ' ').trim();\n  \n  // If query becomes empty, use safe fallback\n  if (!sanitized) {\n    sanitized = 'abstract business';\n  }\n\n  return sanitized;\n}\n","// Client-side image caching using IndexedDB and memory cache\n\nexport interface StockImage {\n  url: string;\n  previewUrl: string;\n  width: number;\n  height: number;\n  photographer?: string;\n  provider: 'pexels' | 'unsplash';\n  sourceUrl?: string;\n}\n\nexport interface CachedImageEntry {\n  predictionId: string;\n  provider: string;\n  seed: string;\n  image: StockImage;\n  timestamp: number;\n}\n\nclass ImageCacheManager {\n  private memoryCache = new Map<string, CachedImageEntry>();\n  private dbName = 'auto-images';\n  private storeName = 'images';\n  private db: IDBDatabase | null = null;\n  private initPromise: Promise<void> | null = null;\n\n  private async initDB(): Promise<void> {\n    if (this.initPromise) return this.initPromise;\n\n    this.initPromise = new Promise((resolve, reject) => {\n      const request = indexedDB.open(this.dbName, 1);\n\n      request.onerror = () => reject(request.error);\n      request.onsuccess = () => {\n        this.db = request.result;\n        resolve();\n      };\n\n      request.onupgradeneeded = (event) => {\n        const db = (event.target as IDBOpenDBRequest).result;\n        if (!db.objectStoreNames.contains(this.storeName)) {\n          const store = db.createObjectStore(this.storeName, { keyPath: 'key' });\n          store.createIndex('predictionId', 'predictionId', { unique: false });\n          store.createIndex('timestamp', 'timestamp', { unique: false });\n        }\n      };\n    });\n\n    return this.initPromise;\n  }\n\n  private generateKey(predictionId: string, provider: string, seed: string): string {\n    return `${predictionId}@${provider}@${seed}`;\n  }\n\n  async get(predictionId: string, provider: string, seed: string): Promise<StockImage | null> {\n    const key = this.generateKey(predictionId, provider, seed);\n\n    // PERFORMANCE FIX: Check memory cache first (synchronous, fast)\n    const memoryEntry = this.memoryCache.get(key);\n    if (memoryEntry) {\n      // Check if still fresh (1 hour)\n      if (Date.now() - memoryEntry.timestamp < 60 * 60 * 1000) {\n        return memoryEntry.image;\n      } else {\n        this.memoryCache.delete(key);\n      }\n    }\n\n    // PERFORMANCE FIX: IndexedDB check is async but non-blocking\n    // Return null immediately if memory cache miss - let component handle loading state\n    // IndexedDB check happens in background\n    try {\n      await this.initDB();\n      if (!this.db) return null;\n\n      // Use Promise with timeout to prevent hanging\n      return Promise.race([\n        new Promise<StockImage | null>((resolve) => {\n          const transaction = this.db!.transaction([this.storeName], 'readonly');\n          const store = transaction.objectStore(this.storeName);\n          const request = store.get(key);\n\n          request.onsuccess = () => {\n            const result = request.result;\n            if (result && Date.now() - result.timestamp < 24 * 60 * 60 * 1000) { // 24 hours\n              // Update memory cache\n              this.memoryCache.set(key, result);\n              resolve(result.image);\n            } else {\n              resolve(null);\n            }\n          };\n\n          request.onerror = () => resolve(null);\n        }),\n        // Timeout after 500ms to prevent blocking\n        new Promise<null>((resolve) => setTimeout(() => resolve(null), 500))\n      ]);\n    } catch (error) {\n      // Silently fail - don't block UI\n      return null;\n    }\n  }\n\n  async set(predictionId: string, provider: string, seed: string, image: StockImage): Promise<void> {\n    const key = this.generateKey(predictionId, provider, seed);\n    const entry: CachedImageEntry = {\n      predictionId,\n      provider,\n      seed,\n      image,\n      timestamp: Date.now()\n    };\n\n    // Update memory cache\n    this.memoryCache.set(key, entry);\n\n    // Update IndexedDB\n    try {\n      await this.initDB();\n      if (!this.db) return;\n\n      return new Promise((resolve) => {\n        const transaction = this.db!.transaction([this.storeName], 'readwrite');\n        const store = transaction.objectStore(this.storeName);\n        const request = store.put({ key, ...entry });\n\n        request.onsuccess = () => resolve();\n        request.onerror = () => {\n          console.warn('Image cache set error:', request.error);\n          resolve();\n        };\n      });\n    } catch (error) {\n      console.warn('Image cache set error:', error);\n    }\n  }\n\n  async clear(): Promise<void> {\n    this.memoryCache.clear();\n\n    try {\n      await this.initDB();\n      if (!this.db) return;\n\n      return new Promise((resolve) => {\n        const transaction = this.db!.transaction([this.storeName], 'readwrite');\n        const store = transaction.objectStore(this.storeName);\n        const request = store.clear();\n\n        request.onsuccess = () => resolve();\n        request.onerror = () => {\n          console.warn('Image cache clear error:', request.error);\n          resolve();\n        };\n      });\n    } catch (error) {\n      console.warn('Image cache clear error:', error);\n    }\n  }\n\n  // Clean up old entries (call periodically)\n  async cleanup(): Promise<void> {\n    const cutoff = Date.now() - 7 * 24 * 60 * 60 * 1000; // 7 days\n\n    // Clean memory cache\n    for (const [key, entry] of this.memoryCache.entries()) {\n      if (entry.timestamp < cutoff) {\n        this.memoryCache.delete(key);\n      }\n    }\n\n    // Clean IndexedDB\n    try {\n      await this.initDB();\n      if (!this.db) return;\n\n      return new Promise((resolve) => {\n        const transaction = this.db!.transaction([this.storeName], 'readwrite');\n        const store = transaction.objectStore(this.storeName);\n        const index = store.index('timestamp');\n        const request = index.openCursor(IDBKeyRange.upperBound(cutoff));\n\n        request.onsuccess = (event) => {\n          const cursor = (event.target as IDBRequest).result;\n          if (cursor) {\n            cursor.delete();\n            cursor.continue();\n          } else {\n            resolve();\n          }\n        };\n\n        request.onerror = () => {\n          console.warn('Image cache cleanup error:', request.error);\n          resolve();\n        };\n      });\n    } catch (error) {\n      console.warn('Image cache cleanup error:', error);\n    }\n  }\n}\n\nexport const imageCache = new ImageCacheManager();\n\n// Clean up cache periodically (every hour)\nif (typeof window !== 'undefined') {\n  setInterval(() => {\n    imageCache.cleanup();\n  }, 60 * 60 * 1000);\n  \n  // Expose cache clearing function globally for debugging\n  (window as unknown as { __clearImageCache: () => Promise<void> }).__clearImageCache = async () => {\n    console.log('[Image Cache] Clearing all cached images...');\n    await imageCache.clear();\n    console.log('[Image Cache] âœ… Cache cleared. Refresh page to reload images.');\n  };\n}\n","/**\n * Stable Image Provider for Prediction Cards\n * \n * Ensures:\n * 1. Images are contextual to prediction title + category\n * 2. Once assigned, images never change for a prediction (stored in DB)\n * 3. Primary provider (Pexels) with automatic fallback to backup (Unsplash)\n * 4. No flickering - image is locked once loaded\n * \n * Priority order:\n * 1. Database image_url (permanent, never changes)\n * 2. IndexedDB cache (local persistence)\n * 3. Pexels API (primary provider)\n * 4. Unsplash API (fallback provider)\n * 5. Gradient fallback (if all else fails)\n */\n\nimport { useState, useEffect, useCallback, useRef } from 'react';\nimport { buildImageQuery, generateSeed, sanitizeQuery } from './queries';\nimport { StockImage, imageCache } from './cache';\nimport type { Prediction } from './useAutoImage';\nimport { qaLog } from '../../utils/devQa';\nimport { getApiUrl } from '@/utils/environment';\n\nconst API_BASE = `${getApiUrl()}/api`;\n\n/**\n * Save image URL to database for permanent storage\n * Only saves if not already set (prevents changing)\n */\nasync function saveImageToDatabase(predictionId: string, imageUrl: string): Promise<void> {\n  // Guard: Don't save if prediction ID is missing or empty\n  if (!predictionId || predictionId.trim() === '') {\n    qaLog(`[stable-image] Skipping database save - no prediction ID`);\n    return;\n  }\n  \n  try {\n    const response = await fetch(`${API_BASE}/v2/predictions/${predictionId}/image`, {\n      method: 'PATCH',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ imageUrl }),\n    });\n    \n    if (response.ok) {\n      qaLog(`[stable-image] Saved image to database for ${predictionId}`);\n    }\n  } catch (err) {\n    // Non-critical - cache will still work\n    qaLog(`[stable-image] Failed to save image to database:`, err);\n  }\n}\n\nexport interface StableImageResult {\n  image: StockImage | null;\n  loading: boolean;\n  error: string | null;\n  usedFallback: boolean;\n  provider: 'pexels' | 'unsplash' | 'none';\n}\n\ninterface StableImageOptions {\n  prediction: Prediction;\n  enabled?: boolean;\n}\n\n/**\n * Stable image hook that ensures:\n * - Contextual images based on title + category\n * - Image stability (never changes once assigned)\n * - Automatic fallback from Pexels to Unsplash\n * - No flickering\n */\nexport function useStableImage({\n  prediction,\n  enabled = true\n}: StableImageOptions): StableImageResult {\n  const [image, setImage] = useState<StockImage | null>(null);\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [usedFallback, setUsedFallback] = useState(false);\n  const [provider, setProvider] = useState<'pexels' | 'unsplash' | 'none'>('pexels');\n  \n  // Lock image once loaded to prevent any changes\n  const imageLocked = useRef(false);\n  const fetchedRef = useRef(false);\n\n  // Reset locks when prediction changes\n  useEffect(() => {\n    imageLocked.current = false;\n    fetchedRef.current = false;\n  }, [prediction.id]);\n\n  const fetchStableImage = useCallback(async () => {\n    // Don't fetch if already locked or already fetching\n    if (imageLocked.current || fetchedRef.current || !enabled) {\n      return;\n    }\n\n    // CRITICAL FIX: Images should be enabled by default\n    // Only disable if explicitly set to 'false'\n    const imagesEnabled = import.meta.env.VITE_IMAGES_FEATURE_FLAG !== 'false';\n    if (!imagesEnabled) {\n      setUsedFallback(true);\n      setProvider('none');\n      imageLocked.current = true;\n      return;\n    }\n\n    fetchedRef.current = true;\n    let cancelled = false;\n\n    try {\n      setLoading(true);\n      setError(null);\n\n      // Generate stable query and seed\n      const query = sanitizeQuery(buildImageQuery(prediction));\n      const seed = generateSeed(prediction);\n\n      qaLog(`[stable-image] Fetching for prediction ${prediction.id}:`, {\n        query,\n        seed,\n        title: prediction.title,\n        category: prediction.category,\n        dbImageUrl: prediction.image_url\n      });\n\n      // 0. PRIORITY: Check if prediction has image_url in database (permanent storage)\n      if (prediction.image_url && !cancelled) {\n        qaLog(`[stable-image] Using database image for ${prediction.id}: ${prediction.image_url.slice(0, 50)}...`);\n        setImage({\n          url: prediction.image_url,\n          previewUrl: prediction.image_url,\n          width: 800,\n          height: 600,\n          photographer: '',\n          provider: 'pexels',\n        });\n        setProvider('pexels'); // Treat as primary provider\n        imageLocked.current = true;\n        setLoading(false);\n        return;\n      }\n\n      // 1. Check cache for Pexels first\n      const cachedPexels = await imageCache.get(prediction.id, 'pexels', seed);\n      if (cachedPexels && !cancelled) {\n        qaLog(`[stable-image] Using cached Pexels image for ${prediction.id}`);\n        setImage(cachedPexels);\n        setProvider('pexels');\n        imageLocked.current = true;\n        setLoading(false);\n        // Save to database for permanent storage (non-blocking)\n        if (cachedPexels.url) {\n          saveImageToDatabase(prediction.id, cachedPexels.url);\n        }\n        return;\n      }\n\n      // 2. Check cache for Unsplash\n      const cachedUnsplash = await imageCache.get(prediction.id, 'unsplash', seed);\n      if (cachedUnsplash && !cancelled) {\n        qaLog(`[stable-image] Using cached Unsplash image for ${prediction.id}`);\n        setImage(cachedUnsplash);\n        setProvider('unsplash');\n        setUsedFallback(true);\n        imageLocked.current = true;\n        setLoading(false);\n        // Save to database for permanent storage (non-blocking)\n        if (cachedUnsplash.url) {\n          saveImageToDatabase(prediction.id, cachedUnsplash.url);\n        }\n        return;\n      }\n\n      // 3. Try Pexels (primary provider)\n      const pexelsImage = await fetchFromProvider('pexels', query, seed);\n      if (pexelsImage && !cancelled) {\n        qaLog(`[stable-image] Got Pexels image for ${prediction.id}`);\n        setImage(pexelsImage);\n        setProvider('pexels');\n        await imageCache.set(prediction.id, 'pexels', seed, pexelsImage);\n        imageLocked.current = true;\n        setLoading(false);\n        // Save to database for permanent storage (non-blocking)\n        if (pexelsImage.url) {\n          saveImageToDatabase(prediction.id, pexelsImage.url);\n        }\n        return;\n      }\n\n      // 4. Fallback to Unsplash (backup provider)\n      qaLog(`[stable-image] Pexels failed, trying Unsplash for ${prediction.id}`);\n      const unsplashImage = await fetchFromProvider('unsplash', query, seed);\n      if (unsplashImage && !cancelled) {\n        qaLog(`[stable-image] Got Unsplash image for ${prediction.id}`);\n        setImage(unsplashImage);\n        setProvider('unsplash');\n        setUsedFallback(true);\n        await imageCache.set(prediction.id, 'unsplash', seed, unsplashImage);\n        imageLocked.current = true;\n        setLoading(false);\n        // Save to database for permanent storage (non-blocking)\n        if (unsplashImage.url) {\n          saveImageToDatabase(prediction.id, unsplashImage.url);\n        }\n        return;\n      }\n\n      // 5. Both providers failed - use gradient fallback\n      qaLog(`[stable-image] All providers failed for ${prediction.id}`);\n      setUsedFallback(true);\n      setProvider('none');\n      imageLocked.current = true;\n\n    } catch (err) {\n      if (!cancelled) {\n        const errorMessage = err instanceof Error ? err.message : 'Unknown error';\n        qaLog(`[stable-image] Error for ${prediction.id}:`, errorMessage);\n        setError(errorMessage);\n        setUsedFallback(true);\n        setProvider('none');\n        imageLocked.current = true;\n      }\n    } finally {\n      if (!cancelled) {\n        setLoading(false);\n      }\n    }\n\n    async function fetchFromProvider(\n      providerName: 'pexels' | 'unsplash',\n      query: string,\n      seed: string\n    ): Promise<StockImage | null> {\n      try {\n        const params = new URLSearchParams({\n          q: query,\n          seed,\n          provider: providerName,\n          take: '1'\n        });\n\n        // PERFORMANCE FIX: Reduced timeout to prevent hanging\n        const response = await fetch(`${API_BASE}/images?${params}`, {\n          signal: AbortSignal.timeout(5000) // 5 second timeout (reduced from 10s)\n        });\n\n        if (!response.ok) {\n          throw new Error(`HTTP ${response.status}`);\n        }\n\n        const data = await response.json();\n\n        if (data.success && data.images && data.images.length > 0) {\n          // Select first image (already filtered by seed on backend)\n          return data.images[0] as StockImage;\n        }\n\n        return null;\n      } catch (err) {\n        qaLog(`[stable-image] ${providerName} fetch failed:`, err);\n        return null;\n      }\n    }\n\n    return () => {\n      cancelled = true;\n    };\n  }, [prediction, enabled]);\n\n  // CRITICAL FIX: Fetch images immediately - don't delay with idle callback\n  // Images are essential for UX and should load as soon as possible\n  useEffect(() => {\n    fetchStableImage();\n  }, [fetchStableImage]);\n\n  return {\n    image,\n    loading,\n    error,\n    usedFallback,\n    provider\n  };\n}\n\n","import type { PredictionMediaInput } from '@/lib/media';\nimport { useStableImage } from '@/features/images/StableImageProvider';\nimport type { Prediction } from '@/features/images/useAutoImage';\n\nexport type MediaItem = {\n  id: string;\n  url: string;\n  alt: string;\n  provider: string;\n};\n\ntype Status = 'idle' | 'loading' | 'ready' | 'error';\n\n// For backwards compatibility with existing code\nexport function useMedia(\n  id: string,\n  prediction?: PredictionMediaInput\n) {\n  // Normalize input so we always have a stable prediction object\n  const safePrediction: PredictionMediaInput = prediction ?? {\n    id: id || '',\n    title: '',\n    category: undefined,\n  };\n\n  // Map the semantic media input into the stable image prediction shape\n  const stablePrediction: Prediction = {\n    id: safePrediction.id,\n    title: safePrediction.title || safePrediction.question || 'Prediction',\n    category: safePrediction.category,\n    description:\n      safePrediction.description ??\n      safePrediction.question ??\n      '',\n  };\n\n  // Use the stable image pipeline backed by /api/images + IndexedDB cache.\n  // This guarantees:\n  // - Deterministic image selection per prediction (seeded)\n  // - Pexels primary, Unsplash fallback\n  // - No image \"flapping\" across reloads\n  const {\n    image,\n    loading,\n    error,\n    usedFallback,\n  } = useStableImage({\n    prediction: stablePrediction,\n    enabled: true,\n  });\n\n  const media: MediaItem = {\n    id: stablePrediction.id,\n    url: image?.url ?? '',\n    alt: image\n      ? `Image related to: ${stablePrediction.title}`\n      : stablePrediction.title,\n    provider: image?.provider ?? (usedFallback ? 'fallback' : 'none'),\n  };\n\n  let status: Status;\n  if (loading && !image) status = 'loading';\n  else if (image) status = 'ready';\n  else if (error) status = 'error';\n  else status = 'idle';\n\n  return { media, status };\n}\n\n// Legacy prefetch - now a no-op since we have caching\nexport function prefetchMedia(_predictions: any[], _max = 8) {\n  // No-op: new system handles caching automatically\n  console.log('[useMedia] prefetchMedia is deprecated - caching is automatic');\n}\n","/**\n * User display utilities\n */\n\ntype UserLike = {\n  full_name?: string | null;\n  username?: string | null;\n  displayName?: string | null;\n  handle?: string | null;\n};\n\n/**\n * Get display name for a user/creator\n * Priority: full_name > displayName > @username > @handle > \"Anonymous\"\n */\nexport const displayNameFor = (user?: UserLike): string => {\n  if (!user) return 'Anonymous';\n  \n  // Try full_name first\n  if (user.full_name && user.full_name.trim()) {\n    return user.full_name.trim();\n  }\n  \n  // Try displayName\n  if (user.displayName && user.displayName.trim()) {\n    return user.displayName.trim();\n  }\n  \n  // Try username (with @ prefix)\n  if (user.username && user.username.trim()) {\n    return `@${user.username.trim()}`;\n  }\n  \n  // Try handle (with @ prefix)\n  if (user.handle && user.handle.trim()) {\n    return `@${user.handle.trim()}`;\n  }\n  \n  return 'Anonymous';\n};\n\n/**\n * Alias for compatibility\n */\nexport const creatorDisplay = displayNameFor;\n\n","import React from 'react';\nimport { BadgeCheck } from 'lucide-react';\nimport { displayNameFor } from '@/lib/users';\n\nexport type CreatorInfo = {\n  id?: string;\n  username?: string | null;\n  full_name?: string | null;\n  avatar_url?: string | null;\n  is_verified?: boolean | null;\n  displayName?: string | null;\n  handle?: string | null;\n  avatarUrl?: string | null;\n};\n\ninterface CreatorBylineProps {\n  creator?: CreatorInfo;\n  className?: string;\n}\n\n/**\n * Displays creator information with avatar and name\n * Shows \"Created by [name]\" with optional verification badge\n */\nexport default function CreatorByline({ creator, className = '' }: CreatorBylineProps) {\n  const avatarUrl = creator?.avatar_url || creator?.avatarUrl;\n  const displayName = displayNameFor(creator);\n  \n  return (\n    <div className={`flex items-center gap-2 text-sm text-muted-foreground ${className}`}>\n      {avatarUrl && (\n        <img\n          src={avatarUrl}\n          alt=\"\"\n          className=\"size-5 rounded-full object-cover bg-muted\"\n          loading=\"lazy\"\n          referrerPolicy=\"no-referrer\"\n          onError={(e) => {\n            // Hide broken images\n            (e.target as HTMLImageElement).style.display = 'none';\n          }}\n        />\n      )}\n      <span>Created by</span>\n      <span className=\"font-medium text-foreground flex items-center gap-1\">\n        {displayName}\n        {creator?.is_verified && (\n          <BadgeCheck className=\"size-4 text-primary\" aria-label=\"Verified\" />\n        )}\n      </span>\n    </div>\n  );\n}\n\n"],"names":["STOPWORDS","MAX_KEYWORDS","extractKeywords","text","limit","word","CATEGORY_QUERIES","ENTITY_OVERRIDES","THEME_RULES","buildTextHaystack","prediction","identityValues","popularityDescriptors","opt","matchEntityOverride","haystack","override","keyword","getThemeEnrichments","enrichments","rule","detectYear","sources","source","match","addKeywords","target","words","normalizeNumber","value","numeric","popularityKeywords","popularity","keywords","pool","players","score","comments","likes","buildImageQuery","keywordSet","year","normalizedCategory","categoryQuery","phrase","fallbackCategory","generateSeed","sanitizeQuery","query","blocklist","sanitized","term","ImageCacheManager","__publicField","resolve","reject","request","event","db","store","predictionId","provider","seed","key","memoryEntry","result","image","entry","cutoff","cursor","imageCache","API_BASE","getApiUrl","saveImageToDatabase","imageUrl","qaLog","useStableImage","enabled","setImage","useState","loading","setLoading","error","setError","usedFallback","setUsedFallback","setProvider","imageLocked","useRef","fetchedRef","useEffect","fetchStableImage","useCallback","cancelled","cachedPexels","cachedUnsplash","pexelsImage","fetchFromProvider","unsplashImage","err","errorMessage","providerName","params","response","data","useMedia","id","safePrediction","stablePrediction","media","status","displayNameFor","user","CreatorByline","creator","className","avatarUrl","displayName","jsxs","jsx","e","BadgeCheck"],"mappings":"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"}