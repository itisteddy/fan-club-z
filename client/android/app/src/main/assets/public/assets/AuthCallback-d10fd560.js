import{j as s}from"./ui-6244b3df.js";import{r as p}from"./vendor-499a370b.js";import{ab as S,d as j,ac as b,ad as w}from"./index-6112b649.js";import"./utils-17ec81d9.js";function y(){return s.jsx("div",{className:"flex h-screen items-center justify-center bg-gray-50",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-500 mx-auto mb-4"}),s.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Completing Sign In..."}),s.jsx("p",{className:"text-gray-600",children:"Please wait while we finish setting up your account."})]})})}const F=()=>{const{supabase:i}=S(),l=j(),[h,v]=p.useState(null);return p.useEffect(()=>{(async()=>{try{console.log("================================================================================"),console.log("AUTH CALLBACK STARTED"),console.log("================================================================================"),console.log("Current URL:",window.location.href);const{data:{session:t},error:k}=await i.auth.getSession();if(t&&!k){console.log("âœ… Already have a valid session, skipping PKCE flow"),console.log("User:",t.user.email);const n=new URLSearchParams(window.location.search).get("next"),c=b(),r=w(n??c??"/");console.log("Redirecting to:",r),await new Promise(e=>setTimeout(e,500)),l(r,{replace:!0});return}const d=new URLSearchParams(window.location.search),g=d.get("next");console.log("Next from URL:",g),console.log("Decoded next:",g?decodeURIComponent(g):null);const f=b();console.log("Next from storage:",f);const u=d.get("code"),x=d.get("code_verifier");if(console.log("Auth callback parameters:",{code:u?"present":"missing",codeVerifier:x?"present":"missing",allParams:Object.fromEntries(d.entries())}),console.log("SessionStorage contents:",{supabaseCodeVerifier:sessionStorage.getItem("supabase.auth.code_verifier"),allKeys:Object.keys(sessionStorage).filter(o=>o.includes("supabase")||o.includes("auth"))}),u){console.log("Exchanging code for session...");let o=x;const n=["supabase.auth.code_verifier","sb-ihtnsyhknvltgrksffun-auth-token.code_verifier","supabase.code_verifier","auth.code_verifier"];for(const e of n){const a=sessionStorage.getItem(e);if(a){o=a,console.log(`Found code verifier in sessionStorage key: ${e}`);break}}if(!o)for(const e of n){const a=localStorage.getItem(e);if(a){o=a,console.log(`Found code verifier in localStorage key: ${e}`);break}}console.log("Final code verifier status:",o?"found":"not found");let c,r;try{if(o){console.log("Attempting code exchange with explicit code verifier...");const e=await i.auth.exchangeCodeForSession({authCode:u,codeVerifier:o});c=e.data,r=e.error}else{console.log("Attempting code exchange without explicit code verifier...");const e=await i.auth.exchangeCodeForSession(u);c=e.data,r=e.error}}catch(e){console.error("Code exchange exception:",e),r=e}if(r){console.error("Code exchange error:",r),console.error("Error details:",{message:r.message,code:r.code,status:r.status}),console.log("PKCE failed, checking for existing session...");const{data:{session:e},error:a}=await i.auth.getSession();e&&!a?console.log("Found existing valid session, proceeding with redirect..."):(console.log("No valid session found, but attempting redirect anyway..."),console.log("This might be a PKCE configuration issue. User may need to sign in again."))}else console.log("Code exchange successful!",c)}else{console.log("No code parameter found, checking for existing session...");const{data:{session:o},error:n}=await i.auth.getSession();if(n)throw console.error("Session check error:",n),n;if(!o)throw new Error("No authentication code or valid session found");console.log("Using existing session:",o.user.email)}const m=w(g??f??"/");console.log("Final redirect target:",m),console.log("================================================================================"),await new Promise(o=>setTimeout(o,500)),console.log("Navigating to:",m),l(m,{replace:!0})}catch(t){console.error("Auth callback error:",t),console.error("Error details:",{message:t.message,code:t.code,status:t.status,name:t.name}),v(t.message||"Authentication failed")}})()},[i,l]),h?s.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:s.jsxs("div",{className:"text-center max-w-md mx-auto p-6",children:[s.jsxs("div",{className:"bg-red-50 rounded-lg p-4 mb-4",children:[s.jsx("div",{className:"flex items-center justify-center w-12 h-12 mx-auto mb-4 bg-red-100 rounded-full",children:s.jsx("svg",{className:"w-6 h-6 text-red-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})})}),s.jsx("h2",{className:"text-lg font-semibold text-red-800 mb-2",children:"Authentication Error"}),s.jsx("p",{className:"text-red-600 text-sm mb-4",children:h})]}),s.jsx("button",{onClick:()=>l("/",{replace:!0}),className:"bg-emerald-500 text-white px-6 py-2 rounded-lg hover:bg-emerald-600 transition-colors",children:"Return to Home"})]})}):s.jsx(y,{})};export{F as default};
