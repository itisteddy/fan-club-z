import{K as oe,j as O,h as m,M as V,Q as F,z as y,u as de}from"./index-6112b649.js";import{g as le,u as W,a as ue,b as pe,c as fe}from"./useWriteContract-ab9d8160.js";import{r as f}from"./vendor-499a370b.js";import{j as n}from"./ui-6244b3df.js";import{r as me,d as be,a as he}from"./utils-17ec81d9.js";import{r as ge,w as X,s as ye}from"./public-3a03d500.js";function xe(e,a){const{chainId:t,...s}=a,r=e.getClient({chainId:t});return le(r,ge,"readContract")(s)}function G(e){return e.state.chainId}function ve(e,a){const{onChange:t}=a;return e.subscribe(s=>s.chainId,t)}function we(e,a){return me(e,a)}function Se(e){return JSON.stringify(e,(a,t)=>Ce(t)?Object.keys(t).sort().reduce((s,r)=>(s[r]=t[r],s),{}):typeof t=="bigint"?t.toString():t)}function Ce(e){if(!ee(e))return!1;const a=e.constructor;if(typeof a>"u")return!0;const t=a.prototype;return!(!ee(t)||!t.hasOwnProperty("isPrototypeOf"))}function ee(e){return Object.prototype.toString.call(e)==="[object Object]"}function Ne(e){const{_defaulted:a,behavior:t,gcTime:s,initialData:r,initialDataUpdatedAt:i,maxPages:c,meta:u,networkMode:d,queryFn:S,queryHash:l,queryKey:x,queryKeyHashFn:w,retry:h,retryDelay:K,structuralSharing:j,getPreviousPageParam:C,getNextPageParam:U,initialPageParam:N,_optimisticResults:_,enabled:v,notifyOnChangeProps:E,placeholderData:q,refetchInterval:I,refetchIntervalInBackground:Y,refetchOnMount:$,refetchOnReconnect:D,refetchOnWindowFocus:A,retryOnMount:k,select:Z,staleTime:H,suspense:B,throwOnError:z,config:J,connector:o,query:b,...p}=e;return p}function De(e,a={}){return{async queryFn({queryKey:t}){const s=a.abi;if(!s)throw new Error("abi is required");const{functionName:r,scopeKey:i,...c}=t[1],u=(()=>{const d=t[1];if(d.address)return{address:d.address};if(d.code)return{code:d.code};throw new Error("address or code is required")})();if(!r)throw new Error("functionName is required");return xe(e,{abi:s,functionName:r,args:c.args,...u,...c})},queryKey:Ae(a)}}function Ae(e={}){const{abi:a,...t}=e;return["readContract",Ne(t)]}function je(e){const a=be({...e,queryKeyHashFn:Se});return a.queryKey=e.queryKey,a}function Ee(e={}){const a=oe(e);return f.useSyncExternalStore(t=>ve(a,{onChange:t}),()=>G(a),()=>G(a))}function M(e={}){const{abi:a,address:t,functionName:s,query:r={}}=e,i=e.code,c=oe(e),u=Ee({config:c}),d=De(c,{...e,chainId:e.chainId??u}),S=!!((t||i)&&a&&s&&(r.enabled??!0));return je({...r,...d,enabled:S,structuralSharing:r.structuralSharing??we})}const te=O("0x30c60f688A0082D1b761610ec3c70f6dC1374E95"),ae=[{type:"function",name:"balances",stateMutability:"view",inputs:[{name:"user",type:"address"}],outputs:[{type:"uint256"}]},{type:"function",name:"reserved",stateMutability:"view",inputs:[{name:"user",type:"address"}],outputs:[{type:"uint256"}]}];function ke(){const{address:e,isConnected:a,chainId:t}=W(),{data:s,isLoading:r,error:i,refetch:c}=M({address:te,abi:ae,functionName:"balances",args:e?[e]:void 0,query:{enabled:!!e&&a&&t===m.id,refetchInterval:5e3}}),{data:u,isLoading:d,error:S,refetch:l}=M({address:te,abi:ae,functionName:"reserved",args:e?[e]:void 0,query:{enabled:!!e&&a&&t===m.id,refetchInterval:5e3}}),x=s?Number(s)/1e6:0,w=u?Number(u)/1e6:0,h=x+w,K=r||d,j=i||S,C=async()=>{await Promise.all([c(),l()])};return{availableBalance:s||BigInt(0),reservedBalance:u||BigInt(0),availableUSD:x,reservedUSD:w,totalUSD:h,isLoading:K,error:j,refetch:C,isConnected:a,chainId:t,isCorrectChain:t===m.id}}const Ie=[{type:"function",name:"balanceOf",stateMutability:"view",inputs:[{name:"account",type:"address"}],outputs:[{type:"uint256"}]},{type:"function",name:"decimals",stateMutability:"view",inputs:[],outputs:[{type:"uint8"}]}],Be="0x036CbD53842c5426634e7929541eC2318f3dCF7e",T=O(Be),ne=+"6";function Te(){const{address:e,chainId:a,isConnected:t}=W(),s=!!e&&t&&a===m.id,{data:r,isLoading:i,error:c,refetch:u}=M({address:T,abi:Ie,functionName:"balanceOf",args:e?[O(e)]:void 0,query:{enabled:s,refetchInterval:3e3,retry:3,staleTime:0}});f.useEffect(()=>{console.log("[FCZ-PAY] useUSDCBalance:",{address:e,chainId:a,expectedChainId:m.id,isConnected:t,usdcAddress:T,enabled:s,balanceRaw:r?.toString(),balanceFormatted:r?V(r,ne):"0",isLoading:i,error:c?.message,timestamp:new Date().toISOString()})},[e,a,t,r,i,c,s]),f.useEffect(()=>{c&&s&&console.error("[FCZ-PAY] USDC Balance Error:",c)},[c,s]);const d=r?Number(V(r,ne)):0;return{balance:d,isLoading:i,error:c,refetch:u,hasBalance:d>0,isWrongNetwork:t&&a!==m.id,usdcAddress:T}}function ce(e,a){const{userId:t,predictionId:s,includeEscrow:r=!0,includeActivity:i=!0}=a||{};e.invalidateQueries({queryKey:["wallet"],exact:!1}),e.invalidateQueries({queryKey:["escrow-balance"],exact:!1}),e.invalidateQueries({queryKey:["unified-balance"],exact:!1}),e.invalidateQueries({queryKey:["escrow-snapshot"],exact:!1}),i&&t&&(e.invalidateQueries({queryKey:F.walletActivity(t)}),e.invalidateQueries({queryKey:["onchain-activity"],exact:!1})),r&&t&&e.invalidateQueries({queryKey:F.escrowBalance(t)}),s&&(e.invalidateQueries({queryKey:F.prediction(s)}),e.invalidateQueries({queryKey:F.predictionEntries(s)}),e.invalidateQueries({queryKey:["prediction-activity",s]})),t&&(e.invalidateQueries({queryKey:["user-entries"],exact:!1}),e.invalidateQueries({queryKey:["user-predictions"],exact:!1})),e.invalidateQueries({queryKey:["readContract"],exact:!1}),e.invalidateQueries({queryKey:["onchain-usdc"],exact:!1}),e.invalidateQueries({queryKey:["usdcBalance"],exact:!1})}function Pe(e,a){ce(e,{userId:a?.userId,includeEscrow:!0,includeActivity:!0}),e.invalidateQueries({queryKey:["usdcBalance"]})}function Le(e,a){ce(e,{userId:a?.userId,includeEscrow:!0,includeActivity:!0}),e.invalidateQueries({queryKey:["usdcBalance"]})}const se=O("0x036CbD53842c5426634e7929541eC2318f3dCF7e"),Oe=O("0x30c60f688A0082D1b761610ec3c70f6dC1374E95"),re=[{type:"function",name:"approve",stateMutability:"nonpayable",inputs:[{name:"spender",type:"address"},{name:"amount",type:"uint256"}],outputs:[{type:"bool"}]},{type:"function",name:"allowance",stateMutability:"view",inputs:[{name:"owner",type:"address"},{name:"spender",type:"address"}],outputs:[{type:"uint256"}]}],Ke=[{type:"function",name:"deposit",stateMutability:"nonpayable",inputs:[{name:"amount",type:"uint256"}],outputs:[]}];function Ue(e){return BigInt(Math.round(e*1e6))}function L(e){return Math.max(0,Math.floor(e*100)/100)}function ie(e){return`$${e.toLocaleString(void 0,{maximumFractionDigits:2})}`}function We({open:e,isOpen:a,onClose:t,availableUSDC:s=0,userId:r="",escrowAddress:i=Oe,escrowAbi:c=Ke,title:u="Add Funds (Base USDC)",onSuccess:d}){const S=he(),{address:l,chainId:x,isConnected:w}=W(),h=ue(),{switchChainAsync:K}=pe(),{writeContractAsync:j}=fe(),[C,U]=f.useState(0),[N,_]=f.useState(!1),[v,E]=f.useState("input"),q=f.useRef(!1),I=f.useRef(!0);f.useEffect(()=>(I.current=!0,()=>{I.current=!1}),[]);const{data:Y,refetch:$}=M({address:se,abi:re,functionName:"allowance",args:l&&i?[l,i]:void 0,query:{enabled:!!l&&!!i&&w&&x===m.id}}),D=e??a??!1;if(f.useEffect(()=>{D||(U(0),E("input"),q.current=!1)},[D]),f.useEffect(()=>{if(!D)return;const o=b=>b.key==="Escape"&&!N&&t();return window.addEventListener("keydown",o),()=>window.removeEventListener("keydown",o)},[D,t,N]),!D)return null;if(!i)return n.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",onClick:t,children:n.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4",onClick:o=>o.stopPropagation(),children:[n.jsx("h2",{className:"text-lg font-semibold mb-2 text-red-600",children:"Configuration Error"}),n.jsx("p",{className:"text-gray-600 mb-4",children:"Escrow contract address is not configured. Please contact support or check environment variables."}),n.jsx("button",{onClick:t,className:"w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors",children:"Close"})]})});const A=L(C||0),k=x===m.id,Z=!w||!k||N||A<=0||A>L(s);async function H(){x!==m.id&&await K({chainId:m.id})}function B(o,b,p){let Q;const P=new Promise((g,R)=>{Q=setTimeout(()=>R(new Error(`${p} timed out`)),b)});return Promise.race([o,P]).finally(()=>clearTimeout(Q))}async function z(){if(!l||!i){y.error("Wallet not connected");return}try{_(!0),await H();const o=Ue(A),b=Y||BigInt(0);if(console.log("[FCZ-PAY] Deposit flow started:",{amount:A,units:o.toString(),currentAllowance:b.toString(),escrowAddress:i}),b<o){E("approving"),console.log("[FCZ-PAY] Approving USDC spend...",o.toString()),y.loading("Approving USDC...",{id:"approve"});const g=await B(j({address:se,abi:re,functionName:"approve",args:[i,o]}),12e4,"Approval");console.log("[FCZ-PAY] Approval transaction sent:",g),h&&await B(X(h,{hash:g}),24e4,"Approval receipt"),y.success("USDC approved!",{id:"approve"}),console.log("[FCZ-PAY] Approval confirmed"),await $()}else console.log("[FCZ-PAY] Sufficient allowance, skipping approval");if(E("depositing"),console.log("[FCZ-PAY] Depositing to escrow..."),y.loading("Depositing USDC...",{id:"deposit"}),h)try{await ye(h,{address:i,abi:c,functionName:"deposit",args:[o],account:l})}catch(g){const R=String(g?.shortMessage||g?.message||"Simulation failed");throw R.toLowerCase().includes("insufficient funds")?y.error("Not enough ETH on Base Sepolia to pay gas.",{id:"deposit"}):y.error(R,{id:"deposit"}),g}const p=await B(j({address:i,abi:c,functionName:"deposit",args:[o]}),12e4,"Deposit");console.log("[FCZ-PAY] Deposit transaction sent:",p),h&&await B(X(h,{hash:p}),24e4,"Deposit receipt"),console.log("[FCZ-PAY] ui: deposit success",p);const Q=`${p.slice(0,6)}...${p.slice(-4)}`;y.success(`Deposited ${ie(A)}! Tx: ${Q}`,{id:"deposit",duration:5e3});const P=de.getState().user?.id||r;if(P&&l)try{await fetch("/api/wallet/reconcile",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:P,walletAddress:l,txHash:p})})}catch(g){console.warn("[FCZ-PAY] Reconcile after deposit failed:",g)}Pe(S,{userId:P,txHash:p}),window.dispatchEvent(new CustomEvent("fcz:balance:refresh")),I.current&&(t(),d?.())}catch(o){console.error("[deposit] failed:",o),v==="approving"?y.error(o?.shortMessage??o?.message??"Approval failed",{id:"approve"}):y.error(o?.shortMessage??o?.message??"Deposit failed",{id:"deposit"})}finally{q.current=!1,I.current&&(_(!1),E("input"))}}const J=()=>w?k?v==="approving"?"Approving USDC...":v==="depositing"?"Depositing...":"Continue":"Switch to Base":"Connect wallet";return n.jsxs("div",{className:"fixed inset-0 z-modal",children:[n.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:t}),n.jsxs("div",{className:"z-modal fixed inset-x-0 mx-auto w-full max-w-md rounded-t-2xl bg-white shadow-xl bottom-[calc(64px+env(safe-area-inset-bottom,0px))] max-h-[calc(100vh-env(safe-area-inset-top,0px)-64px-env(safe-area-inset-bottom,0px))] focus:outline-none",children:[n.jsx("div",{className:"mx-auto mt-2 mb-3 h-1.5 w-16 rounded-full bg-gray-200"}),n.jsxs("div",{className:"px-4 pb-3",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("h2",{className:"text-lg font-semibold",children:u}),n.jsx("button",{"aria-label":"Close",onClick:t,className:"rounded-full p-2 hover:bg-gray-100",children:"✕"})]}),n.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["Wallet: ",l?`${l.slice(0,6)}…${l.slice(-4)}`:"Not connected"," · Chain:"," ",x===m.id?"Base Sepolia":n.jsx("span",{className:"text-amber-600",children:"Switch to Base Sepolia"})]})]}),n.jsxs("div",{className:"overflow-y-auto pb-safe px-4 pt-3",children:[v!=="input"&&n.jsxs("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-blue-600 border-t-transparent"}),n.jsxs("p",{className:"text-sm text-blue-900 font-medium",children:[v==="approving"&&"Step 1/2: Approving USDC...",v==="depositing"&&"Step 2/2: Depositing to escrow..."]})]}),n.jsx("p",{className:"text-xs text-blue-700 mt-1",children:"Please confirm in your wallet"})]}),n.jsx("label",{className:"mb-1 block text-sm font-medium",children:"Amount (USDC)"}),n.jsxs("div",{className:"mb-2 flex items-center gap-2",children:[n.jsxs("div",{className:"relative flex-1 min-w-0",children:[n.jsx("input",{inputMode:"decimal",pattern:"[0-9]*",value:C?String(C):"",onChange:o=>{const b=Number(o.target.value.replace(/[^\d.]/g,""));U(Number.isFinite(b)?b:0)},placeholder:"0.00",disabled:N,className:"w-full rounded-lg border border-gray-200 bg-white pl-3 pr-12 py-2 text-base outline-none ring-emerald-500 focus:ring-2 disabled:opacity-50 tabular-nums"}),n.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-500 whitespace-nowrap",children:"USDC"})]}),n.jsx("button",{type:"button",onClick:()=>U(L(s)),disabled:N,className:"rounded-lg border border-gray-200 px-3 py-2 text-xs font-semibold hover:bg-gray-50 disabled:opacity-50 whitespace-nowrap min-w-[56px]",children:"MAX"})]}),n.jsxs("div",{className:"mb-4 text-xs text-gray-500",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{children:"Available in wallet"}),n.jsx("span",{className:"font-medium text-gray-700 tabular-nums",children:ie(s)})]}),n.jsxs("div",{className:"mt-1",children:["This will deposit USDC into the escrow contract on ",n.jsx("b",{children:"Base Sepolia"}),"."]}),v==="input"&&n.jsx("div",{className:"mt-2 text-xs text-amber-700 bg-amber-50 p-2 rounded",children:"ℹ️ You'll need to approve 2 transactions: one to approve USDC, one to deposit."})]}),n.jsx("div",{className:"h-3"})]}),n.jsxs("div",{className:"sticky bottom-0 bg-white px-4 pt-3 pb-4 shadow-[0_-8px_24px_rgba(0,0,0,0.06)]",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("button",{onClick:t,className:"h-11 flex-1 rounded-xl border border-gray-200 font-medium hover:bg-gray-50",children:"Cancel"}),n.jsx("button",{onClick:z,className:"h-11 flex-1 rounded-xl bg-emerald-600 font-semibold text-white hover:bg-emerald-700 disabled:cursor-not-allowed disabled:opacity-50",disabled:Z,children:J()})]}),n.jsx("div",{className:"pb-safe"})]})]})]})}export{We as D,ke as a,Le as i,Te as u};
