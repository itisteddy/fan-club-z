import{f as S,z as a,h,B as A}from"./index-6112b649.js";import{r as u}from"./vendor-499a370b.js";import{a as T}from"./utils-17ec81d9.js";import{u as $,a as v,b as R,c as k}from"./useWriteContract-ab9d8160.js";import{w as L}from"./public-3a03d500.js";/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const K=S("Clock",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]]),_=[{type:"function",name:"postSettlementRoot",stateMutability:"nonpayable",inputs:[{name:"predictionId",type:"bytes32"},{name:"root",type:"bytes32"},{name:"creator",type:"address"},{name:"creatorFee",type:"uint256"},{name:"platform",type:"address"},{name:"platformFee",type:"uint256"}],outputs:[]},{type:"function",name:"claim",stateMutability:"nonpayable",inputs:[{name:"predictionId",type:"bytes32"},{name:"amount",type:"uint256"},{name:"proof",type:"bytes32[]"}],outputs:[]}];function g(s){return`0x${s.replace(/-/g,"").toLowerCase().padEnd(64,"0")}`}function O(){const{address:s,chainId:d,isConnected:m}=$(),n=v(),{switchChainAsync:f}=R(),{writeContractAsync:p}=k(),l=T(),[w,y]=u.useState(!1),[b,C]=u.useState(null),E=u.useCallback(async i=>{y(!0),C(null);try{if(!m||!s)return a.error("Connect wallet to claim"),null;d!==h.id&&await f({chainId:h.id});const o=i.escrowAddress||"0x30c60f688A0082D1b761610ec3c70f6dC1374E95";if(!o)throw new Error("Escrow contract address missing (VITE_BASE_ESCROW_ADDRESS)");const c=g(i.predictionId);a.loading("Submitting claim...",{id:"claim"});const t=await p({address:o,abi:_,functionName:"claim",args:[c,i.amountUnits,i.proof]});try{const e=`fcz:lastTx:claim:${i.predictionId}:${(s||"").toLowerCase()}`;localStorage.setItem(e,t),window.dispatchEvent(new CustomEvent("fcz:tx",{detail:{kind:"claim",txHash:t,predictionId:i.predictionId}}))}catch{}n&&await L(n,{hash:t});try{if(n&&s){const e=await n.getTransactionReceipt({hash:t});if(e?.status&&e.status!=="success")return a.error("Claim reverted — settlement root not posted yet or invalid proof",{id:"claim"}),t;const I="0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",x=`0x000000000000000000000000${s.toLowerCase().slice(2)}`;if((e?.logs||[]).some(r=>Array.isArray(r.topics)&&r.topics.length>=3&&r.topics[0]===I&&r.topics[2]?.toLowerCase()===x)){const r=`${t.slice(0,8)}…${t.slice(-6)}`;a.success("Claim successful! Tx: "+r,{id:"claim"})}else{const r=`${t.slice(0,8)}…${t.slice(-6)}`;a("Claim mined, but no ERC20 transfer detected. View tx: "+r,{id:"claim"})}}else{const e=`${t.slice(0,8)}…${t.slice(-6)}`;a.success("Claim successful! Tx: "+e,{id:"claim"})}}catch{const e=`${t.slice(0,8)}…${t.slice(-6)}`;a.success("Claim successful! Tx: "+e,{id:"claim"})}try{const e=(s||"").toLowerCase();e&&localStorage.setItem(`fcz:claimed:${i.predictionId}:${e}`,"1")}catch{}l.invalidateQueries({queryKey:["wallet","claimable"]}),l.invalidateQueries({queryKey:["prediction",i.predictionId,"merkle-proof"]});try{window.dispatchEvent(new CustomEvent("fcz:balance:refresh"))}catch{}return t}catch(o){let c=o?.shortMessage||o?.message||"Claim failed",t=!1;if(o instanceof A){const e=(o.shortMessage||"").toLowerCase();e.includes("insufficient")&&(c="Insufficient funds to pay gas"),e.includes("user rejected")&&(c="User rejected the transaction"),(e.includes("already claimed")||e.includes("duplicate"))&&(c="Already claimed",t=!0),e.includes("execution reverted")&&(c="Claim reverted — already claimed or invalid proof")}if(t){try{const e=(s||"").toLowerCase();e&&localStorage.setItem(`fcz:claimed:${i.predictionId}:${e}`,"1")}catch{}return l.invalidateQueries({queryKey:["wallet","claimable"]}),l.invalidateQueries({queryKey:["prediction",i.predictionId,"merkle-proof"]}),a.success("Already claimed",{id:"claim"}),null}else return C(c),a.error(c,{id:"claim"}),null}finally{y(!1)}},[s,d,m,n,f,p,l]);return{isClaiming:w,error:b,claim:E}}export{K as C,_ as E,O as u};
