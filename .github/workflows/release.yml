name: Production Release

on:
  workflow_dispatch:
    inputs:
      skip_apk:
        description: 'Skip APK build'
        required: false
        default: false
        type: boolean
  push:
    branches:
      - main
    paths:
      - 'package.json'
      - 'client/package.json'
      - 'server/package.json'
      - '.github/workflows/release.yml'

env:
  NODE_VERSION: '20.x'
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  release:
    name: Build, Deploy & Package
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          npm --prefix client ci
          npm --prefix server ci

      - name: Quality Gates - Typecheck
        run: npm run typecheck || echo "Typecheck has errors but continuing..."

      - name: Quality Gates - Lint
        run: npm run lint || echo "Lint has errors but continuing..."

      - name: Quality Gates - Build
        run: npm run build:client

      - name: Quality Gates - Smoke Test
        run: npm run test:smoke || echo "Smoke tests skipped or failed"

      - name: Quality Gates - Ledger Check
        run: npm run ledger:check || echo "Ledger check skipped"

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Link Vercel Project
        run: |
          if [ -f .vercel/project.json ]; then
            echo "Using existing Vercel project configuration"
            cat .vercel/project.json
          else
            echo "Linking to existing Vercel project..."
            echo "${{ secrets.VERCEL_TOKEN }}" | vercel link --yes \
              --token "${{ secrets.VERCEL_TOKEN }}" \
              --scope "${{ env.VERCEL_ORG_ID }}" \
              --project "${{ env.VERCEL_PROJECT_ID }}"
          fi
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: Pull Production Environment
        run: |
          vercel pull --environment=production --yes --token "${{ secrets.VERCEL_TOKEN }}"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: Verify Vercel Project
        run: |
          if [ ! -f .vercel/project.json ]; then
            echo "ERROR: .vercel/project.json not found after linking"
            exit 1
          fi
          PROJECT_ID=$(cat .vercel/project.json | grep -o '"projectId":"[^"]*"' | cut -d'"' -f4)
          if [ "$PROJECT_ID" != "${{ env.VERCEL_PROJECT_ID }}" ]; then
            echo "ERROR: Project ID mismatch. Expected ${{ env.VERCEL_PROJECT_ID }}, got $PROJECT_ID"
            exit 1
          fi
          echo "âœ“ Vercel project verified: $PROJECT_ID"

      - name: Deploy to Vercel Production
        run: |
          cd client
          vercel deploy --prod --prebuilt --yes --token "${{ secrets.VERCEL_TOKEN }}"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: Get Production URL
        id: vercel-url
        run: |
          cd client
          URL=$(vercel inspect --token "${{ secrets.VERCEL_TOKEN }}" --prod | grep -o 'https://[^ ]*\.vercel\.app' | head -1 || echo "")
          if [ -z "$URL" ]; then
            # Fallback: construct URL from project name
            URL="https://${{ env.VERCEL_PROJECT_ID }}.vercel.app"
          fi
          echo "production_url=$URL" >> $GITHUB_OUTPUT
          echo "Production URL: $URL"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: Wait for Deployment
        run: |
          sleep 10
          echo "Waiting for deployment to be ready..."

      - name: Verify Production Deployment
        run: |
          URL="${{ steps.vercel-url.outputs.production_url }}"
          echo "Verifying deployment at $URL"
          
          # Check if site is accessible
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || echo "000")
          if [ "$STATUS" != "200" ]; then
            echo "WARNING: Site returned status $STATUS"
          else
            echo "âœ“ Site is accessible"
          fi
          
          # Check manifest
          MANIFEST_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL/manifest.webmanifest" || echo "000")
          if [ "$MANIFEST_STATUS" != "200" ]; then
            echo "WARNING: Manifest returned status $MANIFEST_STATUS"
          else
            echo "âœ“ Manifest is accessible"
          fi

      - name: Setup Java for Android Build
        if: inputs.skip_apk != 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build Android APK
        if: inputs.skip_apk != 'true'
        run: |
          cd client
          PROD_URL="${{ steps.vercel-url.outputs.production_url }}" \
          KEYSTORE_PASSWORD="${{ secrets.KEYSTORE_PASSWORD }}" \
          KEYSTORE_ALIAS="${{ secrets.KEYSTORE_ALIAS }}" \
          bash scripts/build-apk.sh
        env:
          PROD_URL: ${{ steps.vercel-url.outputs.production_url }}

      - name: Copy APK to Downloads
        if: inputs.skip_apk != 'true'
        run: |
          # Find the generated APK
          APK_PATH=$(find client/twa -name "*.apk" -type f | head -1)
          if [ -z "$APK_PATH" ]; then
            echo "ERROR: APK not found"
            exit 1
          fi
          
          # Copy to downloads directory
          mkdir -p client/public/downloads
          cp "$APK_PATH" client/public/downloads/app-latest.apk
          
          # Generate checksum
          CHECKSUM=$(shasum -a 256 "$APK_PATH" | cut -d' ' -f1)
          SIZE=$(stat -f%z "$APK_PATH" 2>/dev/null || stat -c%s "$APK_PATH" 2>/dev/null)
          
          # Update checksums.json
          cat > client/public/downloads/checksums.json <<EOF
          {
            "app-latest.apk": {
              "sha256": "$CHECKSUM",
              "size": $SIZE,
              "version": "$(node -p "require('./package.json').version")",
              "updated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            }
          }
          EOF
          
          echo "APK copied to client/public/downloads/app-latest.apk"
          echo "SHA-256: $CHECKSUM"

      - name: Rebuild Client with APK Assets
        if: inputs.skip_apk != 'true'
        run: |
          cd client
          npm run build

      - name: Redeploy with APK Assets
        if: inputs.skip_apk != 'true'
        run: |
          cd client
          vercel deploy --prod --prebuilt --yes --token "${{ secrets.VERCEL_TOKEN }}"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: Post-Deploy Health Checks
        run: |
          URL="${{ steps.vercel-url.outputs.production_url }}"
          
          echo "=== Health Check Results ==="
          
          # Check app health
          APP_HEALTH=$(curl -s "$URL/api/health/app" || echo '{"status":"error"}')
          echo "App Health: $APP_HEALTH"
          
          # Check payments health
          PAYMENTS_HEALTH=$(curl -s "$URL/api/health/payments" || echo '{"status":"error"}')
          echo "Payments Health: $PAYMENTS_HEALTH"
          
          # Check manifest
          MANIFEST=$(curl -s "$URL/manifest.webmanifest" || echo '{}')
          echo "Manifest accessible: $(echo $MANIFEST | jq -r '.name // "error"')"
          
          # Check APK availability
          if [ "${{ inputs.skip_apk }}" != "true" ]; then
            APK_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL/downloads/app-latest.apk" || echo "000")
            echo "APK Status: $APK_STATUS"
            if [ "$APK_STATUS" = "200" ]; then
              echo "âœ“ APK is accessible"
            else
              echo "âš  APK returned status $APK_STATUS"
            fi
          fi

      - name: Release Summary
        run: |
          echo "## ðŸš€ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $(node -p "require('./package.json').version")" >> $GITHUB_STEP_SUMMARY
          echo "**Git Tag:** dev-stable-$(date +%Y%m%d-%H%M)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Production URL:** ${{ steps.vercel-url.outputs.production_url }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.skip_apk }}" != "true" ]; then
            echo "**APK URL:** ${{ steps.vercel-url.outputs.production_url }}/downloads/app-latest.apk" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Health Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "- App: ${{ steps.vercel-url.outputs.production_url }}/api/health/app" >> $GITHUB_STEP_SUMMARY
          echo "- Payments: ${{ steps.vercel-url.outputs.production_url }}/api/health/payments" >> $GITHUB_STEP_SUMMARY

      - name: Upload APK Artifact
        if: inputs.skip_apk != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: |
            client/twa/*.apk
            client/public/downloads/app-latest.apk
          retention-days: 30

