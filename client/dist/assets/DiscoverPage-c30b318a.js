import{u as te,a as q,A as Z,F as he,X as se,K as fe,z as P,E as pe,T as ae,S as ye,b as ve,c as be,Z as je,d as Ne,e as we,_ as ke,n as B,L as Ce}from"./index-326cf240.js";import{j as e,m as j,A as Y}from"./ui-7ef4368a.js";import{r,R as Q}from"./vendor-2237fdcd.js";import{u as re}from"./predictionStore-eaf540ba.js";import{u as Se,M as H,H as le,S as Pe,a as $e}from"./unifiedCommentStore-56cc3bc2.js";import{U as Te}from"./UserAvatar-85bb9649.js";import{f as ne,a as Ee,b as J}from"./format-edd31c5c.js";import{U as Le}from"./users-ca07fcbf.js";import{C as De}from"./clock-619c275c.js";import{I as _e,B as X}from"./input-36d8bde3.js";import{c as z}from"./utils-193bc896.js";import{c as Me}from"./utils-04a081ed.js";import{A as Fe}from"./AppHeader-7d8f7d9f.js";import"./index-2427990d.js";const ie=({username:t,userId:a,displayName:s,className:l="",showAt:i=!0,onClick:o})=>{const m=te(),p=u=>{if(u.stopPropagation(),console.log("ðŸ‘¤ TappableUsername clicked:",{username:t,userId:a,displayName:s}),o){o();return}const x=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;if(a&&a.trim()!==""&&x.test(a.trim()))console.log("ðŸ”— Navigating to profile with userId:",a),m(`/profile/${a.trim()}`);else if(t&&t.trim()!==""){a&&!x.test(a.trim())&&console.warn("âš ï¸ Invalid userId format, using username instead:",a);const h=t.replace("@","").trim();console.log("ðŸ”— Navigating to profile with username:",h),m(`/profile/${h}`)}else{console.warn("âš ï¸ No valid userId or username provided for profile navigation");return}},k=s||(i?`@${t.replace("@","")}`:t.replace("@",""));return e.jsx(j.button,{className:`inline-flex items-center font-medium text-blue-600 hover:text-blue-700 hover:underline transition-all cursor-pointer rounded-md px-1 py-0.5 hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 ${l}`,whileHover:{scale:1.02},whileTap:{scale:.98},onClick:p,type:"button","aria-label":`View profile for ${k}`,children:k})},G=({children:t,onClose:a,error:s})=>s?e.jsx(j.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:a,className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9000]",children:e.jsx("div",{className:"bg-white rounded-lg p-6 max-w-sm mx-4",children:e.jsxs("div",{className:"text-red-600 text-center",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"âš ï¸ Error"}),e.jsx("p",{className:"text-sm",children:s}),e.jsx("button",{onClick:a,className:"mt-4 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600",children:"Close"})]})})}):e.jsx(e.Fragment,{children:t}),Ie=({prediction:t,isOpen:a,onClose:s})=>{const{user:l}=q(),[i,o]=r.useState(""),[m,p]=r.useState(!1),k=r.useRef(null),u=r.useRef(null),[x]=r.useState(()=>Z.generateId("comment-modal"));r.useEffect(()=>{p(!0)},[]);const h=t&&t.id&&t.id.trim()!=="",v=a&&h&&m,{comments:b,commentCount:c,isLoading:g,error:S,isSubmitting:C,fetchComments:F,addComment:I,toggleCommentLike:f}=Se(v?t.id:"");r.useEffect(()=>{v&&F()},[v,F]),r.useEffect(()=>{if(a&&k.current)return u.current=new he(k.current),u.current.activate(),Z.announce("Comments dialog opened"),()=>{u.current&&(u.current.deactivate(),u.current=null)}},[a]),r.useEffect(()=>{if(!a)return;const d=T=>{fe.handleEscape(T,s)};return document.addEventListener("keydown",d),()=>document.removeEventListener("keydown",d)},[a,s]),r.useEffect(()=>{a||o("")},[a,h]);const w=async()=>{if(!(!h||!i.trim()||!l))try{await I(i.trim()),o(""),P.success("Comment added successfully!")}catch(d){console.error("Failed to add comment:",d),P.error(d.message||"Failed to add comment")}},E=async d=>{if(h)try{await f(d)}catch(T){console.error("Failed to toggle comment like:",T),P.error("Failed to update like")}},R=d=>{try{const T=new Date,U=new Date(d),L=Math.floor((T.getTime()-U.getTime())/1e3);return L<60?"Just now":L<3600?`${Math.floor(L/60)}m ago`:L<86400?`${Math.floor(L/3600)}h ago`:`${Math.floor(L/86400)}d ago`}catch{return"Recently"}};return m?a&&!h?e.jsx(G,{onClose:s,error:"Unable to load comments. Invalid prediction data."}):!a||!t?null:e.jsx(Y,{children:e.jsx(G,{onClose:s,children:e.jsx(j.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:s,className:"fixed inset-0 bg-black bg-opacity-50 flex items-end justify-center sm:items-center sm:p-4 z-[9000]",children:e.jsxs(j.div,{ref:k,initial:{opacity:0,y:"100%"},animate:{opacity:1,y:0},exit:{opacity:0,y:"100%"},onClick:d=>d.stopPropagation(),className:"bg-white w-full max-w-lg rounded-t-3xl sm:rounded-3xl overflow-hidden flex flex-col max-h-[90vh] sm:max-h-[80vh]",style:{zIndex:9001},role:"dialog","aria-modal":"true","aria-labelledby":`${x}-title`,"aria-describedby":`${x}-description`,"aria-live":"polite",children:[e.jsxs("div",{className:"p-4 border-b border-gray-100 flex items-center justify-between sticky top-0 bg-white z-10",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(H,{size:20,className:"text-blue-500"}),e.jsxs("div",{children:[e.jsx("h2",{id:`${x}-title`,className:"text-lg font-bold text-gray-900",children:"Comments"}),e.jsxs("p",{id:`${x}-description`,className:"text-sm text-gray-600",children:[c," ",c===1?"comment":"comments"]})]})]}),e.jsx("button",{onClick:s,className:"w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors","aria-label":"Close comments dialog",children:e.jsx(se,{size:18})})]}),e.jsxs("div",{className:"p-4 bg-gray-50 border-b border-gray-100",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-1",children:t.title}),e.jsx("p",{className:"text-sm text-gray-600 line-clamp-2",children:t.description||"No description available"})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:g&&b.length===0?e.jsx("div",{className:"p-4 text-center",children:e.jsx("div",{className:"animate-pulse space-y-3",children:[...Array(3)].map((d,T)=>e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-gray-200 rounded-full"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4 mb-1"}),e.jsx("div",{className:"h-3 bg-gray-200 rounded w-3/4"})]})]},T))})}):S?e.jsxs("div",{className:"p-8 text-center",children:[e.jsx(H,{size:48,className:"text-red-300 mx-auto mb-3"}),e.jsx("p",{className:"text-red-600 font-medium",children:"Failed to load comments"}),e.jsx("p",{className:"text-sm text-red-400 mb-4",children:S}),e.jsx("button",{onClick:()=>F(),className:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",children:"Try Again"})]}):b.length===0?e.jsxs("div",{className:"p-8 text-center",children:[e.jsx(H,{size:48,className:"text-gray-300 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 font-medium",children:"No comments yet"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Be the first to share your thoughts!"})]}):e.jsx("div",{className:"p-4 space-y-4",children:b.map(d=>e.jsx(j.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"flex gap-3",children:e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"bg-gray-50 rounded-2xl px-4 py-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(ie,{username:d.user?.username||"Anonymous",userId:d.user?.id||"anonymous",className:"font-semibold text-gray-900 text-sm hover:text-blue-600",showAt:!1}),e.jsx("span",{className:"text-xs text-gray-500",children:R(d.created_at)})]}),e.jsx("p",{className:"text-gray-800 text-sm leading-relaxed",children:d.content})]}),e.jsx("div",{className:"flex items-center gap-4 mt-2 ml-4",children:e.jsxs("button",{onClick:()=>E(d.id),className:`flex items-center gap-1 text-xs transition-colors ${d.is_liked?"text-red-500":"text-gray-500 hover:text-red-500"}`,children:[e.jsx(le,{size:14,fill:d.is_liked?"currentColor":"none"}),d.likes_count>0&&e.jsx("span",{children:d.likes_count})]})})]})},d.id))})}),l?e.jsx("div",{className:"p-4 border-t border-gray-100 bg-white sticky bottom-0",children:e.jsx("div",{className:"flex gap-3",children:e.jsxs("div",{className:"flex-1 flex gap-2",children:[e.jsx("input",{type:"text",value:i,onChange:d=>o(d.target.value),onKeyPress:d=>{d.key==="Enter"&&!d.shiftKey&&(d.preventDefault(),w())},placeholder:"Write a comment...",className:"flex-1 px-4 py-2 bg-gray-100 rounded-full focus:ring-2 focus:ring-green-500 focus:bg-white focus:outline-none transition-all text-sm",disabled:C}),e.jsx("button",{onClick:w,disabled:!i.trim()||C,className:"w-8 h-8 rounded-full bg-teal-500 text-white flex items-center justify-center hover:bg-teal-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors",children:e.jsx(Pe,{size:14})})]})})}):e.jsx("div",{className:"p-4 border-t border-gray-100 bg-gray-50 text-center",children:e.jsx("p",{className:"text-gray-600 text-sm",children:"Please log in to join the conversation"})})]})})})}):null},Re=({error:t})=>e.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-red-200 p-4 m-2",children:e.jsxs("div",{className:"text-red-600 text-sm",children:["âš ï¸ Error loading prediction",t&&e.jsx("div",{className:"text-xs mt-1 text-gray-500",children:t})]})}),Ue=({prediction:t,entry:a,variant:s="default",onLike:l,onComment:i,onShare:o,onPredict:m,className:p=""})=>{if(!t||!t.id)return console.warn("âš ï¸ PredictionCard: Invalid prediction data received:",t),e.jsx(Re,{error:"Invalid prediction data"});const k=te(),[u,x]=r.useState(!1),[h,v]=r.useState(!1),[b,c]=r.useState(!1);r.useEffect(()=>{x(!0)},[]);const g=()=>{try{const{toggleLike:y,checkIfLiked:N,getLikeCount:_}=ve();return{toggleLike:y,checkIfLiked:N,getLikeCount:_}}catch(y){return console.warn("Error accessing like store:",y),{toggleLike:async()=>{},checkIfLiked:()=>!1,getLikeCount:()=>0}}},S=()=>{try{const{getCommentCount:y}=$e();return{getCommentCount:y}}catch(y){return console.warn("Error accessing comment store:",y),{getCommentCount:()=>0}}},{toggleLike:C,checkIfLiked:F,getLikeCount:I}=g(),{getCommentCount:f}=S();if(!u)return e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 p-4 animate-pulse",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("div",{className:"w-10 h-10 bg-gray-200 rounded-full"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/3 mb-1"}),e.jsx("div",{className:"h-3 bg-gray-200 rounded w-1/4"})]})]}),e.jsx("div",{className:"h-6 bg-gray-200 rounded mb-2"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"})]});const w=F(t.id)||!1,E=I(t.id),R=E??(t.likes_count||t.likes||0),d=f(t.id),T=d??(t.comments_count||t.comments||0),U=t.entry_deadline||t.entryDeadline,L=U?Math.max(0,new Date(U).getTime()-Date.now()):0,A=Math.floor(L/(1e3*60*60)),O=A<24&&A>0,n=t.participant_count||t.entries?.length||0,$=t.options?.reduce((y,N)=>{const _=N.total_staked||N.totalStaked||0;return y+_},0)||t.pool_total||t.poolTotal||0,D=()=>t.entry_deadline?Ee(new Date(t.entry_deadline)):"â€”",de=async y=>{if(y.stopPropagation(),!b)try{c(!0),await C(t.id),l&&l()}catch(N){console.error("âŒ Error toggling like:",N),P.error("Failed to update like")}finally{c(!1)}},me=y=>{y.stopPropagation(),v(!0),i&&i()},xe=async y=>{y.stopPropagation();try{const N={title:t.question||t.title,text:`Check out this prediction: ${t.question||t.title}`,url:`${window.location.origin}/prediction/${t.id}`};if(navigator.share&&navigator.canShare&&navigator.canShare(N))await navigator.share(N);else if(navigator.clipboard)await navigator.clipboard.writeText(N.url),P.success("Link copied to clipboard!");else{const _=document.createElement("textarea");_.value=N.url,document.body.appendChild(_),_.select(),document.execCommand("copy"),document.body.removeChild(_),P.success("Link copied to clipboard!")}o&&o()}catch(N){console.error("Error sharing:",N),P.error("Failed to share")}},ue=y=>{y.stopPropagation(),m&&m()},ge=y=>{const N=y.target;N.closest("button")||N.closest("a")||N.closest(".interactive")||(console.log("ðŸ”— PredictionCard: Navigating to prediction details:",t.id),k(`/prediction/${t.id}`))};return e.jsxs(e.Fragment,{children:[e.jsxs(j.div,{className:`bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden cursor-pointer ${p}`,whileHover:{scale:1.02,boxShadow:"0 8px 25px rgba(0, 0, 0, 0.1)"},whileTap:{scale:.98},onClick:ge,initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},children:[e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[t.creator?.firstName||t.creator?.email?e.jsxs(e.Fragment,{children:[e.jsx(Te,{email:t.creator?.email,username:t.creator?.firstName||t.creator?.email?.split("@")[0],avatarUrl:t.creator?.avatar,size:"sm"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx(ie,{username:t.creator?.firstName||t.creator?.email?.split("@")[0],className:"font-medium text-gray-900"}),e.jsx("p",{className:"text-sm text-gray-500",children:new Date(t.created_at).toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"})})]})]}):e.jsx("div",{className:"flex-1",children:e.jsx("p",{className:"text-sm text-gray-500",children:new Date(t.created_at).toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"})})}),t.category&&e.jsx("div",{className:"flex-shrink-0",children:e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800",children:t.category})})]}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3 line-clamp-2",children:t.question||t.title}),t.options&&t.options.length>0&&e.jsx("div",{className:"space-y-2 mb-4",children:t.options.map((y,N)=>{const _=y.total_staked||y.totalStaked||0,W=$>0?Math.round(_/$*100):0;return e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 bg-emerald-100 rounded-lg",style:{width:`${W}%`}}),e.jsxs("div",{className:"relative px-3 py-2 flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900",children:y.text||y.option}),e.jsxs("span",{className:"text-sm font-semibold text-emerald-600",children:[W,"%"]})]})]},N)})})]}),e.jsx("div",{className:"px-4 py-3 bg-gray-50 border-t border-gray-100",children:e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"font-semibold text-gray-900",children:ne($)}),e.jsx("span",{className:"text-gray-500",children:"pool"})]}),e.jsxs("div",{className:"flex items-center gap-1 text-gray-600",children:[e.jsx(Le,{className:"w-4 h-4"}),e.jsx("span",{children:n})]}),e.jsxs("div",{className:"flex items-center gap-1 text-gray-600",children:[e.jsx(De,{className:"w-4 h-4"}),e.jsx("span",{className:O?"text-amber-600 font-medium":"",children:D()})]})]}),n>5&&e.jsxs("div",{className:"flex items-center gap-1 text-emerald-600",children:[e.jsx(ae,{className:"w-4 h-4"}),e.jsx("span",{className:"font-medium",children:"Trending"})]})]})}),e.jsx("div",{className:"px-4 py-3 border-t border-gray-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsxs(j.button,{onClick:de,disabled:b,className:`flex items-center gap-2 ${w?"text-red-500":"text-gray-600"} hover:text-red-500 transition-colors interactive`,whileHover:{scale:1.05},whileTap:{scale:.95},children:[e.jsx(le,{className:`w-5 h-5 ${w?"fill-current":""}`}),e.jsx("span",{className:"text-sm font-medium",children:R})]}),e.jsxs(j.button,{onClick:me,className:"flex items-center gap-2 text-gray-600 hover:text-blue-500 transition-colors interactive",whileHover:{scale:1.05},whileTap:{scale:.95},children:[e.jsx(H,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm font-medium",children:T})]}),e.jsxs(j.button,{onClick:xe,className:"flex items-center gap-2 text-gray-600 hover:text-emerald-500 transition-colors interactive",whileHover:{scale:1.05},whileTap:{scale:.95},children:[e.jsx(ye,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm font-medium",children:"Share"})]})]}),e.jsx(j.button,{onClick:ue,className:"bg-gradient-to-r from-purple-600 to-emerald-600 text-white px-6 py-2 rounded-lg font-medium shadow-sm interactive",whileHover:{scale:1.02,boxShadow:"0 8px 25px rgba(123, 47, 247, 0.25)"},whileTap:{scale:.98},children:"Predict Now"})]})})]}),e.jsx(Ie,{prediction:t,isOpen:h,onClose:()=>v(!1)})]})},ze=t=>e.jsx(pe,{children:e.jsx(Ue,{...t})}),Ae=()=>e.jsxs("div",{className:"bg-white rounded-2xl p-4 mx-4 mb-3 shadow-sm border border-gray-100 animate-pulse",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"h-5 bg-gray-200 rounded w-3/4 mb-2"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-full mb-1"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-2/3"})]}),e.jsx("div",{className:"ml-3 flex-shrink-0",children:e.jsx("div",{className:"w-16 h-6 bg-gray-200 rounded-full"})})]}),e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"p-3 border-2 border-gray-200 rounded-xl",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-12 mb-1"}),e.jsx("div",{className:"h-3 bg-gray-200 rounded w-8"})]}),e.jsxs("div",{className:"p-3 border-2 border-gray-200 rounded-xl",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-12 mb-1"}),e.jsx("div",{className:"h-3 bg-gray-200 rounded w-8"})]})]})}),e.jsxs("div",{className:"flex items-center justify-between text-sm mb-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-12"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-8"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-10"})]}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-12"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-8"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-8"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-6"})]}),e.jsx("div",{className:"w-20 h-8 bg-gray-200 rounded-lg"})]})]}),V=r.forwardRef(({className:t,...a},s)=>e.jsx("div",{ref:s,className:z("rounded-xl border bg-card text-card-foreground shadow-sm",t),...a}));V.displayName="Card";const He=r.forwardRef(({className:t,...a},s)=>e.jsx("div",{ref:s,className:z("flex flex-col space-y-1.5 p-6",t),...a}));He.displayName="CardHeader";const Ye=r.forwardRef(({className:t,...a},s)=>e.jsx("h3",{ref:s,className:z("font-semibold leading-none tracking-tight",t),...a}));Ye.displayName="CardTitle";const Oe=r.forwardRef(({className:t,...a},s)=>e.jsx("p",{ref:s,className:z("text-sm text-muted-foreground",t),...a}));Oe.displayName="CardDescription";const K=r.forwardRef(({className:t,...a},s)=>e.jsx("div",{ref:s,className:z("p-6 pt-0",t),...a}));K.displayName="CardContent";const Be=r.forwardRef(({className:t,...a},s)=>e.jsx("div",{ref:s,className:z("flex items-center p-6 pt-0",t),...a}));Be.displayName="CardFooter";const M=t=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(t),Ve=(t,a)=>t*a,ee=(...t)=>t.filter(Boolean).join(" "),Ke=t=>{const a=t.entry_deadline||t.entryDeadline;if(!a)return"Time remaining unknown";const s=Math.max(0,new Date(a).getTime()-Date.now()),l=Math.floor(s/(1e3*60*60));return s<=0?"Ended":l>=24?`${Math.floor(l/24)}d left`:`${l}h left`},qe=({prediction:t,isOpen:a,onClose:s})=>{if(!t||!a)return null;const[l,i]=r.useState(""),[o,m]=r.useState(""),[p,k]=r.useState(!1),{user:u}=q(),{getBalance:x,lockFunds:h}=be(),{placePrediction:v}=re(),b=x("USD")||0,c=parseFloat(o)||0,g=t?.options?.find(f=>f.id===l),S=g?.current_odds||(g?.total_staked?t?.pool_total/g.total_staked:2),C=g?Ve(c,S):0,F=[5,10,25,50,100,250],I=async()=>{if(!l){P.error("Please select a prediction option (Yes or No)");return}if(!c){P.error("Please enter an amount to stake");return}if(c<t.stake_min){P.error(`Minimum stake is ${M(t.stake_min)}. Please increase your amount.`);return}if(t.stake_max&&c>t.stake_max){P.error(`Maximum stake is ${M(t.stake_max)}. Please reduce your amount.`);return}if(c>b){P.error(`Insufficient balance. You have ${M(b)} available, but tried to stake ${M(c)}.`);return}if(!u?.id){P.error("You must be logged in to place predictions");return}k(!0);try{await h(c,"USD"),await v(t.id,l,c,u.id),P.success(`Prediction placed successfully! You staked ${M(c)} on ${g?.label}.`),s(),m(""),i("")}catch(f){const w=f?.message||"Unknown error occurred";P.error(`Failed to place prediction: ${w}. Please try again.`)}finally{k(!1)}};return e.jsx(Y,{mode:"wait",initial:!1,children:a&&e.jsxs(e.Fragment,{children:[e.jsx(j.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm",onClick:s,style:{zIndex:8e3}},"prediction-modal-backdrop"),e.jsx("div",{className:"fixed inset-0 flex items-end justify-center p-4 pb-20",style:{zIndex:8500,pointerEvents:"none"},children:e.jsxs(j.div,{initial:{y:"100%",opacity:0},animate:{y:0,opacity:1},exit:{y:"100%",opacity:0},transition:{type:"spring",damping:30,stiffness:300},className:"w-full max-w-md bg-white rounded-t-2xl shadow-2xl flex flex-col max-h-[75vh]",style:{pointerEvents:"auto"},onClick:f=>f.stopPropagation(),children:[e.jsx("div",{className:"flex-shrink-0 p-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Place Prediction"}),e.jsx("button",{onClick:s,className:"p-2 rounded-lg hover:bg-gray-100 transition-colors","aria-label":"Close modal",children:e.jsx(se,{size:20})})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold text-gray-900 text-base",children:t.title}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-500",children:[e.jsxs("span",{children:[M(t.pool_total||0)," Pool"]}),e.jsx("span",{children:"â€¢"}),e.jsxs("span",{children:[t.participant_count||0," Players"]}),e.jsx("span",{children:"â€¢"}),e.jsx("span",{children:Ke(t)})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"Select your prediction:"}),e.jsx("div",{className:"space-y-2",children:(t.options||[]).map(f=>{const w=f.total_staked||0,E=t.pool_total||1,R=E>0?Math.min(w/E*100,100):50,d=f.current_odds||(w>0?E/w:2);return e.jsx(V,{className:ee("cursor-pointer transition-all border-2",l===f.id?"border-teal-500 bg-teal-50":"border-gray-200 hover:border-gray-300"),onClick:()=>i(f.id),children:e.jsx(K,{className:"p-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-gray-900",children:f.label}),e.jsxs("div",{className:"text-sm text-gray-500",children:[R.toFixed(1),"%"]})]}),e.jsx("div",{className:"text-right",children:e.jsxs("div",{className:"text-lg font-bold text-teal-600",children:[d.toFixed(2),"x"]})})]})})},f.id||Math.random())})})]}),e.jsx(Y,{mode:"wait",children:l&&e.jsxs(j.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},transition:{duration:.2},className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Stake amount"}),e.jsxs("div",{className:"relative",children:[e.jsx(_e,{type:"number",placeholder:"0.00",value:o,onChange:f=>m(f.target.value),className:"pl-8 pr-4 h-12 text-lg font-medium",min:t.stake_min,max:t.stake_max||b}),e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 font-medium",children:"$"})]}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-500 mt-2",children:[e.jsxs("span",{children:["Balance: ",M(b)]}),e.jsx("button",{onClick:()=>m(b.toString()),className:"text-blue-600 hover:text-blue-700 font-medium",children:"Max"})]})]}),e.jsx("div",{children:e.jsx("div",{className:"grid grid-cols-3 gap-2",children:F.map(f=>e.jsxs(X,{variant:"outline",size:"sm",onClick:()=>m(f.toString()),disabled:f>b,className:"text-sm h-10",children:["$",f]},f))})}),c>0&&e.jsx(V,{className:"bg-teal-50 border-teal-200",children:e.jsx(K,{className:"p-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Potential return"}),e.jsx("div",{className:"text-lg font-bold text-teal-600",children:M(C)})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Profit"}),e.jsx("div",{className:ee("font-semibold",C>c?"text-teal-600":"text-red-600"),children:M(C-c)})]})]})})})]},`amount-input-${l}`)})]}),e.jsx("div",{className:"flex-shrink-0 p-4 border-t border-gray-200 bg-white",children:e.jsx(X,{onClick:I,disabled:!l||!c||p||c>b,className:"w-full h-12 bg-teal-500 hover:bg-teal-600 disabled:bg-gray-400 text-white font-semibold rounded-xl transition-all duration-200 shadow-lg flex items-center justify-center",children:p?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:"Placing..."})]}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(je,{size:16}),e.jsxs("span",{children:["Place Prediction (",M(c),")"]})]})})})]},"prediction-modal-content")})]})})},Qe=({hasNext:t,loading:a,onLoadMore:s,threshold:l=200,disabled:i=!1,container:o=null})=>{const m=r.useRef(!1),p=r.useCallback(()=>{if(i||a||!t||m.current)return;let u,x,h;o?(u=o.scrollTop,x=o.scrollHeight,h=o.clientHeight):(u=window.pageYOffset||document.documentElement.scrollTop,x=document.documentElement.scrollHeight,h=window.innerHeight||document.documentElement.clientHeight);const v=x-(u+h);v<=l&&(console.log("ðŸ”„ Infinite scroll triggered:",{distanceFromBottom:v,threshold:l,hasNext:t,loading:a,container:o?"container":"window"}),m.current=!0,s(),setTimeout(()=>{m.current=!1},1e3))},[i,a,t,l,s,o]);return r.useEffect(()=>{if(i)return;let u;const x=()=>{clearTimeout(u),u=setTimeout(p,100)},h=o||window,v="scroll",b="touchmove";return h.addEventListener(v,x,{passive:!0}),o||window.addEventListener(b,x,{passive:!0}),()=>{h.removeEventListener(v,x),o||window.removeEventListener(b,x),clearTimeout(u)}},[p,i,o]),{triggerLoadMore:r.useCallback(()=>{!i&&!a&&t&&!m.current&&(console.log("ðŸ”„ Manual infinite scroll trigger"),m.current=!0,s(),setTimeout(()=>{m.current=!1},1e3))},[i,a,t,s])}},We=Me((t,a)=>({positions:{},saveScrollPosition:(s,l)=>{t(i=>({positions:{...i.positions,[s]:{path:s,scrollY:l,timestamp:Date.now()}}}))},getScrollPosition:s=>{const l=a().positions[s];return l&&Date.now()-l.timestamp<10*60*1e3?l.scrollY:null},clearOldPositions:()=>{const s=Date.now(),l=10*60*1e3;t(i=>({positions:Object.fromEntries(Object.entries(i.positions).filter(([,o])=>s-o.timestamp<l))}))}})),Ze=(t,a={})=>{const[s]=Ne(),{saveScrollPosition:l,getScrollPosition:i}=We(),o=r.useRef(""),{saveOnUnmount:m=!0,restoreOnMount:p=!0,preserveFor:k=10,threshold:u=50}=a,x=r.useCallback(()=>t?.current?t.current:document.querySelector("[data-scroll-container]")||document.documentElement,[t]),h=r.useCallback(()=>{const c=x(),g=c===document.documentElement?window.pageYOffset||document.documentElement.scrollTop:c.scrollTop;g>u&&(console.log(`ðŸ’¾ Saving scroll position for ${s}: ${g}px`),l(s,g))},[s,u,l,x]),v=r.useCallback(()=>{const c=x(),g=i(s);return g!==null&&g>0?(console.log(`ðŸ”„ Restoring scroll position for ${s}: ${g}px`),setTimeout(()=>{c===document.documentElement?window.scrollTo({top:g,behavior:"smooth"}):c.scrollTo({top:g,behavior:"smooth"})},100),!0):!1},[s,i,x]),b=r.useCallback(c=>{const g=x(),S=g===document.documentElement?window.pageYOffset||document.documentElement.scrollTop:g.scrollTop,C=c||s;S>u&&(console.log(`ðŸ’¾ Manually saving scroll for ${C}: ${S}px`),l(C,S))},[s,u,l,x]);return r.useEffect(()=>{let c;return p&&(c=setTimeout(()=>{v()},50)),()=>{c&&clearTimeout(c),m&&h()}},[p,m,v,h]),r.useEffect(()=>{o.current&&o.current!==s&&console.log(`ðŸ”„ Location changed from ${o.current} to ${s}`),o.current=s},[s]),{saveScroll:b,restoreScroll:v,saveCurrentScroll:h}},oe=Q.memo(function({selectedCategory:a,onSelect:s}){const l=[{id:"all",label:"All",icon:"ðŸŒŸ"},{id:"sports",label:"Sports",icon:"âš½"},{id:"pop_culture",label:"Pop Culture",icon:"ðŸŽ¬"},{id:"custom",label:"Custom",icon:"âœ¨"},{id:"politics",label:"Politics",icon:"ðŸ—³ï¸"},{id:"crypto",label:"Crypto",icon:"â‚¿"},{id:"tech",label:"Tech",icon:"ðŸ’»"},{id:"finance",label:"Finance",icon:"ðŸ“ˆ"}];return e.jsx("div",{className:"category-filters bg-white border-b border-gray-100 px-4 py-3","data-tour-id":"category-filters",children:e.jsx("div",{className:"category-filters-container overflow-x-auto -mx-2 px-2",children:e.jsx("div",{className:"category-filters-flex flex gap-2 pb-1",children:l.map(i=>e.jsx(j.button,{onClick:()=>s(i.id),className:`
                category-pill flex-shrink-0 inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm font-medium
                transition-all duration-200 whitespace-nowrap
                ${a===i.id?"active bg-purple-500 text-white shadow-sm":"bg-gray-100 text-gray-700 hover:bg-gray-200"}
              `,whileTap:{scale:.96},children:e.jsx("span",{children:i.label})},i.id))})})})});oe.displayName="CategoryFilters";const ce=Q.memo(function({stats:a,searchQuery:s,onSearchChange:l}){return e.jsxs("div",{className:"px-4 pt-4 pb-4 bg-white",children:[e.jsxs(j.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"bg-gradient-to-r from-emerald-50 to-teal-50 rounded-2xl p-4 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("div",{className:"w-2 h-2 bg-emerald-500 rounded-full animate-pulse"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:"LIVE MARKETS"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-bold text-gray-900",children:ne(a?.totalVolume)}),e.jsx("div",{className:"text-xs text-gray-600",children:"Volume"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-bold text-gray-900",children:J(a?.activePredictions)}),e.jsx("div",{className:"text-xs text-gray-600",children:"Live"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-bold text-gray-900",children:J(a?.totalUsers)}),e.jsx("div",{className:"text-xs text-gray-600",children:"Players"})]})]})]}),e.jsxs("div",{className:"relative","data-tour-id":"search-bar",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(we,{className:"h-5 w-5 text-gray-400"})}),e.jsx("input",{type:"text",placeholder:"Search predictions...",value:s,onChange:i=>l(i.target.value),className:"w-full pl-10 pr-4 py-3 bg-gray-50 border-0 rounded-xl text-gray-900 placeholder-gray-500 focus:bg-white focus:ring-2 focus:ring-emerald-500 focus:outline-none transition-all"})]})]})});ce.displayName="DiscoverHeaderContent";const Je=Q.memo(function({onNavigateToProfile:a,onNavigateToPrediction:s}){q();const{predictions:l,loading:i,loadingMore:o,pagination:m,filters:p,refreshPredictions:k,loadMorePredictions:u,setFilters:x}=re(),[h,v]=r.useState(null),[b,c]=r.useState(!1),g=r.useRef(null),{saveScroll:S}=Ze(g,{saveOnUnmount:!0,restoreOnMount:!0,preserveFor:15,threshold:100}),[C,F]=r.useState({totalVolume:"0",activePredictions:0,totalUsers:"0",rawVolume:0,rawUsers:0}),I=r.useCallback(async()=>{try{const{getApiUrl:n}=await ke(()=>import("./index-326cf240.js").then(D=>D.Q),["assets/index-326cf240.js","assets/ui-7ef4368a.js","assets/vendor-2237fdcd.js","assets/utils-04a081ed.js","assets/index-2dfb5297.css"]),$=await fetch(`${n()}/api/v2/predictions/stats/platform`);if($.ok){const D=await $.json();D.success&&(F(D.data),console.log("âœ… Platform stats fetched:",D.data))}else console.error("Failed to fetch platform stats:",$.status)}catch(n){console.error("Error fetching platform stats:",n)}},[]);Qe({hasNext:m.hasNext,loading:o,onLoadMore:()=>{console.log("ðŸ”„ Infinite scroll triggered in DiscoverPage:",{hasNext:m.hasNext,loading:o,currentPage:m.page,total:m.total}),u()},threshold:300,container:g.current}),r.useEffect(()=>{k(),I()},[k,I]);const f=r.useMemo(()=>({totalVolume:C.totalVolume,activePredictions:C.activePredictions,totalUsers:C.totalUsers}),[C]),w=r.useMemo(()=>!l||!Array.isArray(l)?(console.log("ðŸ” DiscoverPage Debug - No valid predictions array:",l),[]):(console.log(`ðŸ” DiscoverPage Debug - Displaying ${l.length} predictions`),l.filter(n=>!n||!n.id||!n.title?(console.warn("âš ï¸ DiscoverPage: Invalid prediction object:",n),!1):!0)),[l]),E=r.useCallback(n=>{v(n),c(!0)},[]),R=r.useCallback(n=>{S("/discover"),s?s(n):window.location.href=`/prediction/${n}`},[s,S]),d=r.useCallback(n=>{B.success("Prediction liked!")},[]),T=r.useCallback(n=>{S("/discover"),R(n)},[R,S]),U=r.useCallback(n=>{const $=`Check out this prediction: ${n.title}`,D=`${window.location.origin}/prediction/${n.id}`;navigator.share?navigator.share({title:n.title,text:$,url:D}).catch(console.error):navigator.clipboard.writeText(`${$}
${D}`).then(()=>B.success("Link copied to clipboard!")).catch(()=>B.error("Failed to copy link"))},[]),L=r.useCallback(n=>{console.log("ðŸ” Search query changed:",n),x({search:n})},[x]),A=r.useCallback(n=>{console.log("ðŸ“‚ Category changed:",n),x({category:n})},[x]),O=r.useCallback(()=>{c(!1),v(null)},[]);return i&&(!l||l.length===0)?e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsxs("div",{className:"bg-white border-b border-gray-100",children:[e.jsx("div",{className:"h-11"}),e.jsxs("div",{className:"px-4 pb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"h-8 bg-gray-200 rounded w-24 mb-2 loading-skeleton"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-32 loading-skeleton"})]}),e.jsx("div",{className:"w-10 h-10 bg-gray-200 rounded-full loading-skeleton"})]}),e.jsxs("div",{className:"bg-gray-200 rounded-2xl p-4 mb-4 loading-skeleton",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded w-20 mb-3 loading-skeleton"}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"h-6 bg-gray-300 rounded mb-1 loading-skeleton"}),e.jsx("div",{className:"h-3 bg-gray-300 rounded w-16 mx-auto loading-skeleton"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"h-6 bg-gray-300 rounded mb-1 loading-skeleton"}),e.jsx("div",{className:"h-3 bg-gray-300 rounded w-12 mx-auto loading-skeleton"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"h-6 bg-gray-300 rounded mb-1 loading-skeleton"}),e.jsx("div",{className:"h-3 bg-gray-300 rounded w-14 mx-auto loading-skeleton"})]})]})]}),e.jsx("div",{className:"h-12 bg-gray-200 rounded-xl loading-skeleton"})]})]}),e.jsx("div",{className:"px-4 py-3 bg-white border-b border-gray-100",children:e.jsx("div",{className:"flex gap-2 overflow-x-auto",children:[1,2,3,4,5,6].map(n=>e.jsx("div",{className:"h-8 bg-gray-200 rounded-full w-20 flex-shrink-0 loading-skeleton"},n))})}),e.jsxs("div",{className:"py-4",children:[e.jsxs("div",{className:"px-4 mb-6",children:[e.jsx("div",{className:"h-8 bg-gray-200 rounded w-32 mb-2 loading-skeleton"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-24 loading-skeleton"})]}),e.jsx("div",{className:"space-y-2",children:[1,2,3,4,5].map(n=>e.jsx(Ae,{},n))})]})]}):e.jsxs("div",{ref:g,className:"discover-page content-with-bottom-nav","data-scroll-container":!0,style:{position:"relative",zIndex:1,overflowY:"auto",height:"100vh"},children:[e.jsx(Fe,{title:"Discover"}),e.jsx(ce,{stats:f,searchQuery:p.search,onSearchChange:L}),e.jsx("div",{className:"category-filters-wrapper",style:{position:"relative",zIndex:45},children:e.jsx(oe,{selectedCategory:p.category,onSelect:A})}),e.jsxs("div",{className:"prediction-cards-container",children:[e.jsxs(j.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"px-4 mb-4",children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-900 mb-1","data-tour-id":"discover-list",children:[p.category==="all"?"All Predictions":`${p.category} Predictions`,p.search&&` - "${p.search}"`]}),m.total>0&&e.jsxs("p",{className:"text-sm text-gray-600",children:["Showing ",w.length," of ",m.total," predictions",m.hasNext&&" â€¢ Scroll for more"]})]}),e.jsx("div",{className:"space-y-2",children:e.jsx(Y,{mode:"wait",children:w.length>0?e.jsxs(e.Fragment,{children:[w.map((n,$)=>!n||!n.id?(console.warn("âš ï¸ DiscoverPage: Skipping invalid prediction at index",$),null):e.jsx(ze,{prediction:n,variant:"compact",onPredict:()=>E(n),onLike:()=>d(n.id),onComment:()=>T(n.id),onShare:()=>U(n)},`${n.id}-${$}`)),o&&e.jsxs(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"flex items-center justify-center py-8",children:[e.jsx(Ce,{className:"w-6 h-6 animate-spin text-purple-500 mr-3"}),e.jsx("span",{className:"text-gray-600",children:"Loading more predictions..."})]}),m.hasNext&&!o&&e.jsxs(j.div,{initial:{opacity:0},animate:{opacity:1},className:"text-center py-6",children:[e.jsxs("button",{onClick:()=>{console.log("ðŸ”„ Manual load more triggered"),u()},className:"bg-purple-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-purple-600 transition-colors",children:["Load More (",m.total-w.length," remaining)"]}),e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:["Page ",m.page," â€¢ ",w.length,"/",m.total]})]}),!m.hasNext&&!o&&w.length>10&&e.jsx(j.div,{initial:{opacity:0},animate:{opacity:1},className:"text-center py-8",children:e.jsx("p",{className:"text-gray-500 text-sm",children:"ðŸŽ‰ You've seen all predictions!"})})]}):e.jsxs(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:"text-center py-12 px-4",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(ae,{size:24,className:"text-gray-400"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"No predictions found"}),e.jsx("p",{className:"text-gray-600",children:p.search?`No predictions match "${p.search}"`:i?"Loading predictions...":"Try adjusting your filters or check back later"}),!i&&!p.search&&e.jsx("button",{onClick:()=>k(!0),className:"mt-4 px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors",children:"Refresh Predictions"})]})})})]}),e.jsx(qe,{prediction:h,isOpen:b,onClose:O})]})});Je.displayName="DiscoverPage";export{Je as default};
