import{r as s}from"./vendor-c36eaa8e.js";import{b as q}from"./utils-617af415.js";import{m as x,o as L,p as O,q as D}from"./wagmi-c444efa6.js";const N=3e3,Q=["no matching key","session topic","session not found","pairing topic","missing session","inactive session","session disconnected","expired session","getdefaultprovider","provider.request","wallet disconnected","walletconnect","topic not found","missing or invalid","proposal expired","wc_session","relay connection","socket hang up","fetch failed","ns sepolia","no provider","provider is undefined","disconnected from","please call connect() before request","client not initialized","pairing not found","session request timeout","peer disconnected","connection closed","request timeout","transport error","signerclient is undefined","provider not found","connector not connected","no signer available"],A=["wallet","allowance","balance","escrow","readContract","usdcBalance","escrow-balance","unified-balance","escrow-snapshot","onchain-usdc","claimable-claims","merkle-proof","wallet-summary","onchain-activity"];function Y(){const{isConnected:l,isConnecting:w,status:p}=x(),{disconnect:d}=L(),{reconnect:v}=O(),E=D(),h=q(),f=s.useRef(!1),S=s.useRef(0),b=s.useRef(!0);s.useRef(!1);const W=s.useRef({isConnected:l,isConnecting:w,status:p});s.useEffect(()=>{W.current={isConnected:l,isConnecting:w,status:p}},[l,w,p]),s.useEffect(()=>(b.current=!0,()=>{b.current=!1}),[]);const y=s.useCallback(t=>{if(!t)return!1;const o=typeof t=="object"&&"message"in t?String(t.message).toLowerCase():String(t).toLowerCase();return Q.some(c=>o.includes(c))},[]),i=s.useCallback(async()=>{try{const t=E.find(n=>n.id==="walletConnect");if(t)try{const n=await t.getProvider().catch(()=>null);n&&typeof n.disconnect=="function"&&await n.disconnect().catch(()=>{})}catch{}const o=[];for(let n=0;n<localStorage.length;n++){const e=localStorage.key(n);e&&(e.startsWith("wc@2:")||e.startsWith("wc@1:")||e.startsWith("walletconnect")||e.startsWith("WALLETCONNECT")||e.includes("wc_session")||e.includes("@walletconnect")||e.startsWith("wc_")||e.includes("pairing")||e.includes("relay")||e.includes("topic")&&e.includes("wc")||e.includes("wallet-connect")||e.includes("wagmi")&&e.includes("walletConnect"))&&o.push(e)}o.forEach(n=>{try{localStorage.removeItem(n)}catch{}});const c=[];for(let n=0;n<sessionStorage.length;n++){const e=sessionStorage.key(n);e&&(e.startsWith("wc@2:")||e.startsWith("walletconnect")||e.includes("@walletconnect"))&&c.push(e)}c.forEach(n=>{try{sessionStorage.removeItem(n)}catch{}}),o.length+c.length>0}catch{}},[E]),u=s.useCallback(()=>{A.forEach(t=>{h.invalidateQueries({queryKey:[t],exact:!1}),h.removeQueries({queryKey:[t],exact:!1})})},[h]),k=s.useCallback(async()=>{try{d(),await new Promise(t=>setTimeout(t,100)),await i(),u(),window.dispatchEvent(new CustomEvent("fcz:wallet:disconnected"))}catch(t){throw await i(),t}},[d,i,u]),g=s.useCallback(async()=>{try{return await v(),!0}catch{return!1}},[v]),R=s.useCallback(async t=>{const{attemptReconnect:o=!1}=t||{},c=Date.now();if(c-S.current<N||f.current)return!1;f.current=!0,S.current=c;try{if(await i(),l)try{d()}catch{}return await new Promise(a=>setTimeout(a,200)),u(),o&&(await new Promise(n=>setTimeout(n,500)),await g()),!0}catch{return!1}finally{f.current=!1}},[i,l,d,u,g]),P=s.useCallback(async(t,o)=>{const c=o?.maxRetries??1,a=o?.retryDelay??1e3,n=o?.operationTimeoutMs??6e4;let e=null;for(let m=0;m<=c;m++)try{const r=t(),C=new Promise((T,_)=>{setTimeout(()=>_(new Error("Wallet operation timed out")),n)});return await Promise.race([r,C])}catch(r){e=r;const C=r instanceof Error&&r.message.includes("timed out");if((y(r)||C)&&(await R({attemptReconnect:m===0}),m<c)){await new Promise(T=>setTimeout(T,a));continue}throw r}throw e},[y,R]);return{disconnectWithCleanup:k,recoverFromError:R,cleanupWalletConnectSessions:i,isSessionError:y,withSessionRecovery:P,invalidateWalletQueries:u,attemptReconnect:g,isRecovering:f.current}}export{Y as u};
