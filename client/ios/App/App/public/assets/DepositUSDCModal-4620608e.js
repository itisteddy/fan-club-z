import{m as re,j as S,x as be,g as L,z as he,r as ge,t as we,v as ye,w as Z,y as G}from"./wagmi-c444efa6.js";import{j as e}from"./ui-c369d1f3.js";import{r as o}from"./vendor-c36eaa8e.js";import{b as ve}from"./utils-617af415.js";import{c as Ce,z as g,a as Se,al as B,p as _,m as O,l as Ee,at as Ne,q as ee,r as De,s as je}from"./index-78beacc5.js";import{u as Ae}from"./useWalletConnectSession-1627a74c.js";const Re=[{type:"function",name:"balanceOf",stateMutability:"view",inputs:[{name:"account",type:"address"}],outputs:[{type:"uint256"}]},{type:"function",name:"decimals",stateMutability:"view",inputs:[],outputs:[{type:"uint8"}]}];function _e(t){if(!t)throw new Error("USDC address not configured");const s=t.trim();if(!s.startsWith("0x")||s.length!==42)throw new Error(`Invalid address format: ${s}`);return L(s)}const Ie="0x036CbD53842c5426634e7929541eC2318f3dCF7e",te=_e(Ie),Me=+"6";function ze(){const{address:t,chainId:s,isConnected:p}=re(),w=!!t&&p&&s===S.id,{data:E,isLoading:c,error:y,refetch:I}=be({address:te,abi:Re,functionName:"balanceOf",args:t?[L(t)]:void 0,query:{enabled:w,refetchInterval:3e4,staleTime:2e4,gcTime:6e4,retry:2,refetchOnWindowFocus:!1,refetchOnMount:!1}}),N=E?Number(he(E,Me)):0;return{balance:N,isLoading:c,error:y,refetch:I,hasBalance:N>0,isWrongNetwork:p&&s!==S.id,usdcAddress:te}}function ie(t){if(!t)throw new Error("USDC address not configured");const s=t.trim();if(!s.startsWith("0x")||s.length!==42)throw new Error(`Invalid address format: ${s}`);return L(s)}const Ue="0x036CbD53842c5426634e7929541eC2318f3dCF7e",se=ie(Ue),We=(()=>{const t="0x30c60f688A0082D1b761610ec3c70f6dC1374E95",s={}.VITE_ESCROW_ADDRESS_BASE_SEPOLIA;if(s&&t.trim().toLowerCase()!==s.trim().toLowerCase())throw new Error(`[FCZ-PAY] Escrow address mismatch. VITE_BASE_ESCROW_ADDRESS (${t}) !== VITE_ESCROW_ADDRESS_BASE_SEPOLIA (${s}). Fix env to a single canonical escrow.`);const p=t;return p?ie(p):void 0})(),ae=[{type:"function",name:"approve",stateMutability:"nonpayable",inputs:[{name:"spender",type:"address"},{name:"amount",type:"uint256"}],outputs:[{type:"bool"}]},{type:"function",name:"allowance",stateMutability:"view",inputs:[{name:"owner",type:"address"},{name:"spender",type:"address"}],outputs:[{type:"uint256"}]},{type:"function",name:"balanceOf",stateMutability:"view",inputs:[{name:"account",type:"address"}],outputs:[{type:"uint256"}]}],ke=[{type:"function",name:"deposit",stateMutability:"nonpayable",inputs:[{name:"amount",type:"uint256"}],outputs:[]}],C=1;function Te(t){return BigInt(Math.round(t*1e6))}function $(t){return Math.max(0,Math.floor(t*100)/100)}function ne(t){return`$${t.toLocaleString(void 0,{maximumFractionDigits:2})}`}function qe({open:t,isOpen:s,onClose:p,availableUSDC:w=0,userId:E="",escrowAddress:c=We,escrowAbi:y=ke,title:I="Add Funds",onSuccess:N}){const P=ve(),{address:a,chainId:F,isConnected:H}=re(),x=ge(),{switchChainAsync:oe}=we(),{writeContractAsync:z,reset:M}=ye(),{sessionHealthy:ce}=Ce(),{withSessionRecovery:q,isSessionError:V}=Ae(),[U,W]=o.useState(0),[r,K]=o.useState(!1),[k,D]=o.useState("input"),[Q,b]=o.useState(null),[J,m]=o.useState(""),j=o.useRef(!1),A=o.useRef(!0);o.useEffect(()=>(A.current=!0,()=>{A.current=!1}),[]);const v=t??s??!1,X=F===S.id,le=H&&a&&X&&ce!==!1;o.useEffect(()=>{v||(W(0),D("input"),b(null),m(""),j.current=!1,M())},[v,M]),o.useEffect(()=>{if(!v)return;const n=l=>l.key==="Escape"&&!r&&h();return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[v,r]);const h=o.useCallback(()=>{r&&(j.current=!0),p()},[r,p]);if(!v)return null;if(!c)return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",onClick:h,children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md mx-4",onClick:n=>n.stopPropagation(),children:[e.jsx("h2",{className:"text-lg font-semibold mb-2 text-red-600",children:"Configuration Error"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Escrow contract not configured."}),e.jsx("button",{onClick:h,className:"w-full px-4 py-2 bg-gray-200 rounded-lg",children:"Close"})]})});const i=$(U||0),Y=i>0&&i<C,de=!le||r||i<=0||i>$(w)||Y;async function ue(){if(!x||!a||!c)return BigInt(0);try{return await x.readContract({address:se,abi:ae,functionName:"allowance",args:[a,c]})}catch{return BigInt(0)}}async function me(){if(!a||!c||!x){g.error("Wallet not connected");return}if(i<C){b(`Minimum deposit is ${C} USDC`),g.error(`Minimum deposit is ${C} USDC`);return}const n=Se.getState().user?.id||E,l=Te(i);try{if(K(!0),b(null),m(""),M(),F!==S.id&&await oe({chainId:S.id}),await ue()<l){D("approving"),m("Approve USDC in your wallet...");let u;try{u=await q(async()=>await z({address:se,abi:ae,functionName:"approve",args:[c,l]}),{maxRetries:1,operationTimeoutMs:2e4})}catch(f){if(B(f))throw new Error("Approval cancelled");if(V(f))throw new Error("Wallet session expired. Please reconnect and try again.");const xe=_(f);throw new Error(`Approval failed: ${xe.message}`)}if(m("Waiting for approval confirmation..."),(await Z(x,{hash:u,confirmations:1,timeout:12e4})).status==="reverted")throw new Error("Approval transaction failed");O({userId:n,walletAddress:a,txHash:u,type:"approval",status:"completed",amount:i}).catch(()=>{}),m("Confirming approval..."),await new Promise(f=>setTimeout(f,4e3)),g.success("USDC approved!",{id:"approve"})}if(j.current)return;D("depositing"),m("Confirm deposit in your wallet...");try{await G(x,{address:c,abi:y,functionName:"deposit",args:[l],account:a})}catch(u){if(_(u).code==="INSUFFICIENT_ALLOWANCE")m("Waiting for approval to propagate..."),await new Promise(f=>setTimeout(f,3e3)),await G(x,{address:c,abi:y,functionName:"deposit",args:[l],account:a});else throw u}let d;try{d=await q(async()=>await z({address:c,abi:y,functionName:"deposit",args:[l]}),{maxRetries:1,operationTimeoutMs:2e4})}catch(u){if(B(u))throw new Error("Deposit cancelled");if(V(u))throw new Error("Wallet session expired. Please reconnect and try again.");const T=_(u);throw new Error(`Deposit failed: ${T.message}`)}if(m("Waiting for deposit confirmation..."),O({userId:n,walletAddress:a,txHash:d,type:"deposit",status:"pending",amount:i}).catch(()=>{}),(await Z(x,{hash:d,confirmations:1,timeout:12e4})).status==="reverted")throw new Error("Deposit transaction failed");O({userId:n,walletAddress:a,txHash:d,type:"deposit",status:"completed",amount:i}).catch(()=>{});const fe=Ee();fetch(`${fe}/api/wallet/reconcile`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:n,walletAddress:a,txHash:d,txType:"deposit",amountUSD:i})}).catch(()=>{}),g.success(e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("span",{children:["Deposited ",ne(i),"!"]}),e.jsx("a",{href:`https://sepolia.basescan.org/tx/${d}`,target:"_blank",rel:"noopener noreferrer",className:"text-xs text-blue-600 underline",children:"View on BaseScan"})]}),{duration:5e3}),Ne(P,{userId:n,txHash:d}),setTimeout(()=>{ee(),P.invalidateQueries({queryKey:["readContract"],exact:!1})},3e3),ee(),A.current&&(h(),N?.())}catch(R){if(B(R))g.dismiss(),b("Transaction cancelled");else if(De(R))je(),b("Wallet session expired. Please reconnect.");else{const d=_(R);b(d.message),g.error(d.message)}}finally{j.current=!1,A.current&&(K(!1),D("input"),m(""))}}const pe=()=>H?X?k==="approving"?"Approving...":k==="depositing"?"Depositing...":"Deposit":"Switch to Base":"Connect wallet";return e.jsxs("div",{className:"fixed inset-0 z-modal",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:r?void 0:h}),e.jsxs("div",{className:"z-modal fixed inset-x-0 mx-auto w-full max-w-md rounded-t-2xl bg-white shadow-xl bottom-[calc(64px+env(safe-area-inset-bottom,0px))] max-h-[calc(100vh-env(safe-area-inset-top,0px)-64px-env(safe-area-inset-bottom,0px))] focus:outline-none",children:[e.jsx("div",{className:"mx-auto mt-2 mb-3 h-1.5 w-16 rounded-full bg-gray-200"}),e.jsxs("div",{className:"px-4 pb-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-lg font-semibold",children:I}),e.jsx("button",{"aria-label":"Close",onClick:h,className:"rounded-full p-2 hover:bg-gray-100",disabled:r,children:"✕"})]}),e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["Wallet: ",a?`${a.slice(0,6)}…${a.slice(-4)}`:"Not connected"]})]}),e.jsxs("div",{className:"overflow-y-auto pb-safe px-4 pt-3",children:[Q&&k==="input"&&e.jsxs("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg",children:[e.jsx("p",{className:"text-sm text-red-800",children:Q}),e.jsx("button",{onClick:()=>b(null),className:"text-xs text-red-600 underline mt-1",children:"Dismiss"})]}),r&&J&&e.jsx("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-blue-600 border-t-transparent"}),e.jsx("p",{className:"text-sm text-blue-900 font-medium",children:J})]})}),e.jsx("label",{className:"mb-1 block text-sm font-medium",children:"Amount (USDC)"}),e.jsxs("div",{className:"mb-2 flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1 min-w-0",children:[e.jsx("input",{inputMode:"decimal",pattern:"[0-9]*",value:U?String(U):"",onChange:n=>{const l=Number(n.target.value.replace(/[^\d.]/g,""));W(Number.isFinite(l)?l:0)},placeholder:"0.00",disabled:r,className:"w-full rounded-lg border border-gray-200 bg-white pl-3 pr-12 py-2 text-base outline-none ring-emerald-500 focus:ring-2 disabled:opacity-50 tabular-nums"}),e.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-500",children:"USDC"})]}),e.jsx("button",{type:"button",onClick:()=>W($(w)),disabled:r,className:"rounded-lg border border-gray-200 px-3 py-2 text-xs font-semibold hover:bg-gray-50 disabled:opacity-50",children:"MAX"})]}),e.jsxs("div",{className:"mb-4 text-xs text-gray-500",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Available in wallet"}),e.jsx("span",{className:"font-medium text-gray-700",children:ne(w)})]}),Y&&e.jsxs("div",{className:"mt-2 text-amber-700 bg-amber-50 border border-amber-200 p-2 rounded-lg",children:["Minimum deposit is ",C," USDC"]}),e.jsx("div",{className:"mt-2 text-slate-600 bg-slate-50 border border-slate-100 p-2 rounded-lg",children:"Deposits USDC into escrow on Base Sepolia. May require 2 transactions."})]})]}),e.jsxs("div",{className:"sticky bottom-0 bg-white px-4 pt-3 pb-4 shadow-[0_-8px_24px_rgba(0,0,0,0.06)]",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:h,className:"h-11 flex-1 rounded-xl border border-gray-200 font-medium hover:bg-gray-50 disabled:opacity-50",disabled:r,children:"Cancel"}),e.jsx("button",{onClick:me,className:"h-11 flex-1 rounded-xl bg-emerald-600 font-semibold text-white hover:bg-emerald-700 disabled:cursor-not-allowed disabled:opacity-50",disabled:de,children:pe()})]}),e.jsx("div",{className:"pb-safe"})]})]})]})}export{qe as D,ze as u};
